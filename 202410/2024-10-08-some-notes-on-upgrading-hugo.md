# Some notes on upgrading Hugo
- URL: https://jvns.ca/blog/2024/10/07/some-notes-on-upgrading-hugo/
- Added At: 2024-10-08 16:02:29
- [Link To Text](2024-10-08-some-notes-on-upgrading-hugo_raw.md)

## TL;DR
作者从Hugo v0.40升级到v0.135，经历了模板语法、页面数据、Markdown渲染器等多方面的变更。主要挑战包括从Blackfriday到Goldmark的转换，导致大量Markdown文件需更新。通过详细对比和配置调整，作者成功完成升级，并认为新渲染器修复了旧问题，对未来有益。

## Summary
1. **升级动机**：
   - 作者决定从Hugo v0.40升级到v0.135，尽管旧版本运行良好，但作者认为这可能是一个有趣的挑战。

2. **主要变更**：
   - **模板语法**：
     - 从`{{ template "theme/partials/thing.html" . }}`改为`{{ partial "thing.html" . }}`。
     - 此变更在v0.42中引入，模板查找语法不再支持。
   - **页面数据**：
     - `.Data.Pages`改为`site.RegularPages`。
     - 此变更在v0.57.2中引入。
   - **前后导航**：
     - `.Next`和`.Prev`的含义被翻转，新的行为更符合直觉。
     - 此变更在ad705aac064中引入。

3. **Markdown渲染器变更**：
   - **Blackfriday到Goldmark**：
     - Blackfriday在v0.100.0中被移除，Goldmark成为默认渲染器。
     - 此变更导致大量Markdown文件需要更新，作者更新了80个文件。
   - **变更原因**：
     - Goldmark使用CommonMark标准，可能更未来证明。
     - Goldmark修复了一些旧渲染器的问题，如智能引号和列表/块引用的交互。

4. **Markdown问题排查**：
   - **过程**：
     - 生成旧版本和新版本的站点，对比HTML文件。
     - 使用脚本逐个检查差异，直到找到并修复所有问题。
   - **具体问题**：
     - **混合HTML和Markdown**：
       - 不再支持某些混合语法，需要调整。
     - **角引号**：
       - `<<`被转换为«，需要配置禁用。
     - **嵌套列表缩进**：
       - 嵌套列表需要4个空格缩进。
     - **列表内块引用**：
       - 新渲染器支持列表内块引用。
     - **列表内标题**：
       - 列表内标题需要转义`#`。
     - **列表识别**：
       - 避免`+`或`1)`在行首，以免被识别为列表。
     - **代码块内智能引号**：
       - 新渲染器不再自动替换代码块内的引号。
     - **引号匹配**：
       - 新渲染器修复了引号不匹配的问题。
     - **图片和换行标签**：
       - 图片不再被`<p>`标签包裹，换行标签现在被`<p>`包裹。

5. **Goldmark配置**：
   - **禁用代码高亮**：
     - 因为新渲染器的高亮功能不正常。
   - **保留旧的标题ID生成方式**：
     - 避免标题ID变化。
   - **允许Markdown中使用原始HTML**。

6. **辅助工具**：
   - **下载变更日志**：
     - 编写脚本从GitHub API下载所有变更日志。
   - **对比渲染结果**：
     - 编写程序对比Blackfriday和Goldmark的渲染结果。

7. **主题维护**：
   - **自定义主题**：
     - 作者使用自定义主题，并将其与站点代码一起维护。
     - 依赖第三方主题可能带来维护问题，作者建议自行维护。

8. **总结**：
   - **Hugo优势**：
     - 快速构建时间和静态二进制文件是作者选择Hugo的主要原因。
   - **变更挑战**：
     - 尽管升级过程耗时且繁琐，但新渲染器修复了一些问题，可能对未来有益。
   - **未来计划**：
     - 作者可能在未来升级其他站点时参考此次经验。
