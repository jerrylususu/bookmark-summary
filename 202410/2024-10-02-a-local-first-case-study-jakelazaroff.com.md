# A Local-First Case Study | jakelazaroff.com
- URL: https://jakelazaroff.com/words/a-local-first-case-study/
- Added At: 2024-10-02 13:57:22
- [Link To Text](2024-10-02-a-local-first-case-study-jakelazaroff.com_raw.md)

## TL;DR
作者因不满现有旅行规划工具，开发了本地优先的网页应用Waypoint，结合富文本编辑器和地图，实现快速数据输入和结构化行程规划，并支持实时协作和离线编辑，展示了本地优先架构的可行性和优势。

## Summary
1. **背景介绍**：作者刚结束一段旅行，虽然旅行很棒，但规划过程却很糟糕。规划六个月的旅行是一项艰巨的任务，作者对现有工具感到不满。

2. **问题与解决方案**：
   - **现有工具不足**：作者尝试了Apple Notes、Notion、Google Maps和Wanderlog，但这些工具要么过于简单，要么过于复杂，难以满足规划需求。
   - **Waypoint的诞生**：作者决定自己开发一个本地优先的网页应用Waypoint，用于规划旅行。

3. **Waypoint的特点**：
   - **数据输入快速**：使用类似于Google Docs的富文本编辑器，数据输入迅速。
   - **比较容易**：所有地点都显示在地图上，便于比较位置关系。
   - **结构化与非结构化数据并重**：用户可以记录松散的笔记，并逐渐形成正式的行程。

4. **界面设计**：
   - **双面板布局**：左侧是文本编辑器，右侧是地图。
   - **地点添加**：通过`@mention`风格的自动完成功能快速添加地点。
   - **路线显示**：使用`~`符号创建路线列表，地图上会自动绘制路线。
   - **聚焦模式**：类似于iA Writer的聚焦模式，只显示当前段落的内容和相关地图信息。

5. **技术实现**：
   - **框架与库**：使用SvelteKit构建网站，Shoelace用于自定义组件，ProseMirror用于富文本编辑器，Stadia Maps和MapLibre GL JS用于地图，Yjs用于客户端数据存储。
   - **本地优先**：Waypoint是一个本地优先的应用，数据存储在客户端，使用CRDT（冲突可复制数据类型）确保数据一致性。

6. **协作与同步**：
   - **实时协作**：使用Y-Sweet库实现实时协作，数据通过WebSocket服务器同步并持久化到S3。
   - **离线编辑**：通过`y-indexeddb`实现离线编辑，即使断网也不会丢失数据。

7. **本地优先的定义与实现**：
   - **定义**：如果客户端拥有数据的权威副本，则该应用是本地优先的。
   - **Waypoint的符合情况**：
     - **无加载动画**：文档编辑是即时的。
     - **跨设备访问**：通过链接加载文档，并可下载数据。
     - **网络可选**：除了自动完成和地图，应用完全离线可用。
     - **无缝协作**：支持实时和异步协作。
     - **长期可用**：文档可离线查看，但部分功能依赖外部服务。
     - **安全与隐私**：文档未加密存储在S3。
     - **用户控制**：用户拥有数据的最终控制权。

8. **开发经验**：
   - **本地优先的优势**：开发体验优于传统单页应用，简化了数据同步和错误处理。
   - **技术挑战**：Svelte与Yjs的集成需要一些调整，但整体开发体验仍然很好。
   - **离线支持**：SvelteKit原生支持服务工作者，离线支持实现相对容易。

9. **总结**：
   - **本地优先的可行性**：使用现有工具可以构建实用的本地优先应用。
   - **技术组合**：各种库的组合使用使得开发变得简单，尤其是文本编辑器类型的应用。
   - **未来展望**：本地优先架构有望大幅简化单页应用的开发。
