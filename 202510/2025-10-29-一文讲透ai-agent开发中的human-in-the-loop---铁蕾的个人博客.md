# 一文讲透AI Agent开发中的human-in-the-loop - 铁蕾的个人博客
- URL: https://zhangtielei.com/posts/blog-ai-agent-human-in-the-loop.html
- Added At: 2025-10-29 15:24:24

## TL;DR
本文阐述了AI Agent开发中Human-in-the-loop机制的必要性，及其技术实现关键。为解决自主性与确定性的矛盾，需在关键环节引入人工干预。实现方案根据通信通道分为两类：可会话保持（如WebSocket）时直接等待反馈；无法保持时需序列化状态并持久化存储。序列化复杂运行时状态是主要挑战，需精简设计以准确恢复状态。

## Summary
**一、Human-in-the-loop的必要性**  
AI Agent开发中存在**自主性**与**确定性**的矛盾：自主性带来智能行为，但软件交付需保证确定性。Human-in-the-loop通过引入人工确认或指导，在关键环节（如部署服务、发送邮件前审核）消除不确定性，提升可靠性。类比实习生与导师的协作，AI Agent在遇到难题时主动请求人类介入，人类提供指导后Agent继续执行，既减轻人类负担，又确保任务可控。

**二、技术实现的关键因素**  
实现human-in-the-loop需解决两个核心问题：  
1. **分布式架构影响**：生产环境多为多节点集群，人工反馈可能被随机分配到非原始节点，导致交互中断。  
2. **通信通道性质**：  
   - **HTTP协议**：仅支持客户端主动请求，无法实现Agent主动发起交互。  
   - **长连接（如WebSocket）**：支持双向通信，易于会话保持，适合Agent主动请求。  
   - **第三方异步通道（如IM）**：无法保证会话保持，反馈可能由任意节点接收。  
此外，网关或SSE技术需额外处理会话一致性。

**三、两种技术方案**  
根据通信通道能否会话保持，分为两类方案：  
1. **可会话保持的场景（如长连接）**：  
   - 利用await机制，Agent发送请求后等待future对象，用户反馈通过同一连接返回，直接恢复执行。  
   - 优点：实现简单；缺点：维护长连接成本高。  
2. **无法会话保持的场景（如HTTP或第三方通道）**：  
   - 需要序列化与持久化：Agent发送请求后，将运行状态序列化存储至数据库并停止；用户反馈到达任意节点时，从数据库加载状态反序列化，恢复执行。  
   - 优点：适应性强；缺点：序列化复杂对象（如运行时状态）难度大。

**四、序列化与反序列化的挑战**  
- 序列化需处理对象间复杂引用关系，尤其是运行时对象（非纯数据对象）的方法绑定和状态依赖。  
- 建议仅序列化必要动态数据，避免冗余，确保恢复时能准确重构Agent状态。

**五、总结**  
Human-in-the-loop是平衡AI自主性与确定性的关键机制，其实现依赖通信通道特性。技术方案需根据架构选择：长连接下直接等待反馈，异步环境下需状态持久化。序列化复杂运行时状态是主要难点，需谨慎设计。后续文章将通过代码示例进一步展开实现细节。
