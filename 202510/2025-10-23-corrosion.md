# Corrosion
- URL: https://fly.io/blog/corrosion/
- Added At: 2025-10-23 15:03:30
- [Link To Text](2025-10-23-corrosion_raw.md)

## TL;DR
Fly.io为解决全球分布式平台状态同步问题，构建了去中心化服务发现系统Corrosion。它采用gossip协议和SQLite数据库变更传播，放弃传统分布式共识以提升性能，尽管遇到了故障并经过多次优化，现已成为一个高效可扩展的开源解决方案。

## Summary
Fly.io构建了一个名为Corrosion的服务发现系统，用于解决其全球平台中的状态同步问题。该系统采用去中心化设计，利用gossip协议传播SQLite数据库的变更，避免了分布式共识协议的性能瓶颈。

**背景与问题**  
Fly.io平台通过微虚拟机（Fly Machines）在全球运行容器，其调度模型以单个服务器为状态源头，而非集中式数据库。原有的Consul系统在全局路由中存在延迟和一致性挑战，尤其在长距离网络下共识协议效率低下。

**Corrosion的设计特点**  
- **基于gossip协议**：采用SWIM成员协议和QUIC通信，快速同步节点状态变更。  
- **无锁与无中心节点**：利用CRDT扩展（cr-sqlite）处理冲突，通过逻辑时间戳实现最终一致性。  
- **SQLite接口**：对外呈现为可直接查询的数据库，简化使用。

**故障与教训**  
- 曾因Rust并发bug导致全局代理死锁，引发严重停机。  
- 其他问题包括模式变更引发的集群过载、与Consul并发的资源饱和等。这些事件促使系统加固。

**优化与改进**  
- **监控与测试**：为Tokio程序添加看门狗机制，防止死锁；使用Antithesis进行深度测试。  
- **数据备份与恢复**：定期备份数据库，支持集群重建。  
- **更新策略**：改用全量数据推送，避免增量更新带来的潜在错误。  
- **区域化架构**：将全局集群拆分为区域级集群，限制故障影响范围。

**总结**  
Corrosion通过放弃传统共识协议，实现了高效、可扩展的状态同步。尽管开发过程充满挑战，但其设计适用于需要快速收敛、去中心化的场景，并已开源供社区使用。
