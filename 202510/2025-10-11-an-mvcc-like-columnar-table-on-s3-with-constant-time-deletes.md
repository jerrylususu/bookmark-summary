# An MVCC-like columnar table on S3 with constant-time deletes
- URL: https://www.shayon.dev/post/2025/277/an-mvcc-like-columnar-table-on-s3-with-constant-time-deletes/
- Added At: 2025-10-11 14:11:41

## TL;DR
本文提出了一种基于S3的MVCC列式表格式，通过不可变的数据和墓碑文件、CAS更新清单指针实现无协调的并发控制。适用于追加为主的场景，具有低写入成本，但需处理文件增长和墓碑压缩问题。

## Summary
本文提出了一种基于S3对象存储的类MVCC列式表格式设计，旨在结合Parquet的优势并实现常量时间删除。核心思路是利用S3的条件写入功能（如If-Match和If-None-Match）实现无外部协调的原子操作，支持多版本并发控制（MVCC）和快照隔离。

### 关键设计点
- **对象布局**：数据文件（Parquet格式）和墓碑文件（记录删除标记）均不可变，仅通过一个可变的`_latest_manifest`指针对象（使用CAS更新）来引用当前表状态。目录结构包含数据文件、墓碑文件和清单文件版本链。
- **删除机制**：通过写入小型墓碑文件（如标记删除的行组或行范围）实现常量时间删除，无需重写数据文件。读取时结合墓碑文件过滤已删除数据。
- **并发控制**：采用乐观并发协议，写操作通过CAS竞争更新清单指针，失败时重试；读操作通过获取清单快照保证一致性视图。
- **成本与性能**：针对追加密集型分析负载优化，S3请求成本低（如追加数据仅需3次PUT），数据扫描支持谓词下推和列裁剪。墓碑文件使用Roaring Bitmap压缩，减小存储开销。
- **容错与GC**：写失败时产生孤立文件，由定期垃圾回收清理；支持可选压缩合并墓碑文件或重写数据文件。

### 适用场景与局限
- **优势**：适用于追加为主、偶发批量删除的分析负载（如事件日志、时序数据），简化架构（无外部元数据服务）。
- **局限**：清单文件随文件数线性增长可能成为瓶颈，墓碑积累需压缩，缺乏模式演进等成熟工具。与Apache Iceberg等相比，牺牲部分功能以换取简单性。

该设计展示了利用S3原生能力构建轻量级表格式的潜力，但生产环境需考虑扩展性和运维复杂度。
