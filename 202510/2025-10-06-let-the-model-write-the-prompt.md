# Let the Model Write the Prompt
- URL: https://www.dbreunig.com/2025/06/10/let-the-model-write-the-prompt.html
- Added At: 2025-10-06 05:17:13

## TL;DR
DSPy框架通过编程方式定义任务，取代传统提示工程，实现任务与模型解耦。它优化提示生成，提升准确率与模型兼容性，简化代码维护并支持持续改进，适用于如地理空间数据合并等任务。

## Summary
本文讨论了在应用与数据管道中使用DSPy（Declarative Self-improving Programs for LLMs）框架的优势，以解决传统提示工程（prompting）带来的问题。主要内容围绕一个地理空间数据合并（conflation）示例展开，展示了DSPy如何简化、优化并确保LLM任务的可持续性。

### 核心问题：传统提示工程的局限性
- **提示工程的双刃剑**：虽然提示允许非技术专家快速定义任务并实现原型（例如，仅用一两句提示即可运行概念验证），但随着模型的迭代，提示可能变得冗长、难以维护。
- **结构缺失与重复性**：提示通常是非结构化的字符串，混合在代码中，导致团队协作困难、代码可读性低，且需要不断手动调整以适配新模型。例如，OpenAI的SWE-Bench提示中，仅1%内容定义任务，32%用于格式指令，19%用于思维链指令。
- **模型依赖性**：手动优化的提示往往绑定到特定模型，当切换模型时，性能可能下降，需要重新调整。

### DSPy的解决方案
DSPy通过编程方式定义任务，而非直接编写提示，实现任务与模型、提示策略的解耦。其核心理念是：**“未来会有更好的策略、优化和模型，不应依赖单一实现”**。

#### 关键特性：
1. **签名（Signatures）与模块（Modules）**：
   - **签名**：用代码定义输入和输出（例如，`question -> answer` 或自定义类如`PlaceMatcher`），可添加描述性文本以注入领域知识。
   - **模块**：策略性组件（如`Predict`或`ChainOfThought`），将签名转换为实际提示，无需手动处理提示生成或输出解析。
2. **优化与评估**：
   - 使用评估数据（eval data）和指标函数（metric），通过优化器（如MIPROv2）自动生成高效提示。优化过程包括：生成示例、描述程序、生成候选提示，并通过批量评估选择最佳版本。
   - 示例中，经DSPy优化后，模型（Qwen 3 0.6B）在合并任务上的准确率从60.7%提升至82%。
3. **模型可移植性**：
   - 轻松切换不同模型（如Llama 3.2 1B或Phi-4-Mini 3.8B），并重新运行优化，避免手动提示调整。例如，优化后Llama 3.2 1B达到91%准确率。
4. **代码简洁性与可维护性**：
   - 仅需少量代码（如14行）管理复杂提示（约700个token），支持版本控制、团队协作和持续优化。

### 实际应用：地理空间数据合并
- 以Overture Maps Foundation的POI（兴趣点）数据合并为例，演示DSPy如何处理模糊匹配（如名称和地址差异）。
- 通过简单工具（如DuckDB查询和手动标注界面）快速创建评估数据集，然后使用DSPy优化合并程序。

### 优势总结
- **快速启动**：用签名定义任务，无需深入提示细节。
- **持续优化**：随评估数据增长自动改进提示。
- **未来兼容**：适配新模型和技术（如fine-tuning或多阶段模块）。
- **可读性与协作**：代码结构化，易于团队理解和扩展。

### 行动建议
- 从小规模开始，尝试用DSPy签名定义任务。
- 获取高质量评估数据（如手动标注数百个示例）。
- 探索Overture Maps的免费地理空间数据或DSPy高级功能（如SIMBA优化器）。

DSPy的核心思想是**“编写程序，而非提示”**，从而提升LLM应用的效率、可维护性和适应性。
