# Build your own SQS or Kafka with Postgres
- URL: https://blog.sequinstream.com/build-your-own-sqs-or-kafka-with-postgres/
- Added At: 2024-08-01 14:56:39
- [Link To Text](2024-08-01-build-your-own-sqs-or-kafka-with-postgres_raw.md)

## TL;DR
本文介绍了如何利用Postgres构建类似SQS和Kafka的消息系统，包括队列创建、消息接收、FIFO实现、死信队列、分区与并发处理等，并对比了Postgres与SQS、Kafka的优势与劣势。此外，还探讨了结合Kafka和SQS的消费模式，以及Sequin项目的设计理念和当前状态。

## Summary
1. **引言**：
   - **Sequin简介**：Sequin是一个基于Postgres的开源消息流，本文介绍了如何利用Postgres构建类似SQS或Kafka的消息系统。

2. **构建自己的SQS**：
   - **SQS简介**：SQS是AWS提供的一种流行的消息队列服务，本文介绍了如何在Postgres中快速构建一个类似SQS的消息队列。
   - **队列创建**：
     - **表结构**：创建一个类似SQS的消息队列表，包含消息序列号、数据、不可见时间戳等字段。
     - **发送消息**：通过插入操作将消息发送到队列。
   - **接收消息**：
     - **查询可用消息**：通过查询语句选择可用的消息，并使用索引优化查询。
     - **消息接收流程**：在一个查询或事务中完成消息的“认领”和数据获取。
   - **FIFO队列**：
     - **FIFO简介**：在SQS中，队列可以配置为FIFO，确保消息按顺序处理。
     - **实现FIFO**：通过添加`key`字段和调整接收消息逻辑，实现基本的FIFO行为。
     - **高级FIFO**：解决基本FIFO实现中的竞争条件问题，通过增加额外的表和逻辑来优化。
   - **死信队列**：
     - **死信队列简介**：用于存储处理失败的消息，避免浪费队列资源。
     - **实现死信队列**：通过创建`dead_messages`表和相关查询，实现消息的转移和处理。
   - **与SQS的比较**：
     - **优势与劣势**：Postgres在FIFO和吞吐量方面的表现，以及与SQS的对比。

3. **构建自己的Kafka**：
   - **Kafka简介**：Kafka是一种消息系统，与SQS有不同的设计理念。
   - **数据模型**：
     - **消息表**：创建一个包含消息序列号、键和数据的`messages`表。
     - **消费者组偏移表**：创建`consumer_group_offsets`表，存储消费者组的消费状态。
   - **消息接收与确认**：
     - **接收消息**：通过查询锁定消费者组偏移，并获取消息。
     - **消息确认**：在事务结束时更新偏移，确认消息处理完成。
   - **分区与并发**：
     - **分区设计**：通过生成列和分区表，实现消息的并发处理。
     - **分区调整**：讨论分区数量调整的复杂性和影响。
   - **删除旧消息**：
     - **保留策略**：通过编写函数和使用工具如`pg_cron`，实现旧消息的批量删除。
   - **与Kafka的比较**：
     - **优势与劣势**：Postgres在单机性能和可观察性方面的优势，以及与Kafka的对比。

4. **结合Kafka和SQS的消费模式**：
   - **设计理念**：结合Kafka的流处理和SQS的队列处理，实现多范式消息系统。
   - **数据模型**：
     - **消息表**：简化`messages`表，去除分区字段。
     - **消费者消息表**：创建`consumer_messages`表，存储消费者的消息状态。
   - **消息插入与接收**：
     - **消息插入**：通过CTE和批量插入，实现消息的分发。
     - **消息接收**：通过查询和更新操作，实现消息的接收和处理。
   - **新消费者添加**：
     - **消费者添加流程**：确保新消费者的消息插入和历史消息的回填。
   - **潜在问题与解决方案**：
     - **消费者消息表的压力**：讨论消费者消息表的无限增长问题和解决方案。
     - **即时插入消费者消息**：讨论即时插入消费者消息的复杂性和潜在问题。

5. **Sequin项目**：
   - **Sequin简介**：Sequin项目的设计理念和功能，包括消费者子集处理、消息重放等。
   - **项目状态**：项目处于早期阶段，但核心功能正在快速完善。

6. **附录**：
   - **函数与大查询的选择**：讨论在文章中使用大查询而非函数的原因，包括迁移和可读性方面的考虑。
