# Optimizing SPA load times with async chunks preloading
- URL: https://mmazzarolo.com/blog/2024-08-13-async-chunk-preloading-on-load/
- Added At: 2024-08-14 14:56:33

## TL;DR
文章讨论了优化单页应用（SPA）加载时间的方法，包括通过预加载异步页面chunk来避免加载延迟，使用Rsbuild等工具注入自定义脚本，以及基于路由的代码拆分策略。此外，还提到了进一步改进的建议，如强化路由逻辑、压缩注入脚本和使用Service Worker预缓存。

## Summary
1. **优化SPA加载时间**：通过避免基于路由的懒加载导致的瀑布效应，提高客户端渲染应用的性能。
   - **方法**：注入自定义脚本预加载当前路由的chunk，确保它们与入口点chunk并行下载。
   - **工具**：使用Rsbuild进行脚本注入，代码可适应Webpack和其他打包工具。

2. **基于路由的代码拆分**：
   - **策略**：在客户端渲染应用中，代码拆分是提高整体性能的主要策略之一，只加载必要的代码块，而不是一次性加载所有代码。
   - **实现**：通过懒加载路由（或页面）chunk实现，这些chunk仅在用户访问相应页面时加载，而不是提前加载。
   - **优点**：减少应用加载所需的包大小，改善缓存效果。

3. **懒加载的缺点**：
   - **初始加载延迟**：应用首次加载时，存在入口点chunk加载和初始页面加载之间的延迟。
   - **导航延迟**：每次导航到不同页面时，浏览器仅在导航开始时下载、解析和运行新的chunk。
   - **缓解策略**：使用可靠的缓存策略和具有预加载能力的路由器。

4. **预加载异步页面**：
   - **目标**：解决页面必须等待入口点chunk请求后才能下载的水瀑布问题。
   - **方法**：在HTML的head中注入一个小脚本，预加载当前访问URL的异步chunk。
   - **实现**：使用构建工具（如Rsbuild）生成并注入脚本，脚本包含每个路由和应预加载文件的映射。

5. **构建文件列表**：
   - **步骤**：创建插件（适用于Rsbuild，代码可轻松适应Webpack）检查编译输出，确定每个chunk依赖的文件名。
   - **注意**：单个chunk可能依赖多个文件，文件加载顺序重要。

6. **生成预加载脚本**：
   - **步骤**：完成插件，使其将自定义脚本注入HTML文件。脚本在页面加载时执行，为当前路径添加`link rel="preload"`标签。
   - **效果**：所有当前页面的异步chunk将与入口点chunk并行加载。

7. **进一步改进**：
   - **强化路由逻辑**：改进插件API以接受与React Router相同的配置，实现动态路径识别和模式匹配。
   - **压缩注入脚本**：确保预加载脚本不会因包含大量chunk而变得过大。
   - **暴露预加载API**：使预加载执行可编程，允许在运行时调用。
   - **使用Service Worker预缓存**：作为替代方案，使用Service Worker预缓存所有应用chunk。
   - **探索其他优化**：考虑其他性能优化，如确保入口点chunk优先加载，集成更细粒度的非路由组件预加载等。
