# How to Get or Create in PostgreSQL
- URL: https://hakibenita.com/postgresql-get-or-create
- Added At: 2024-08-06 14:44:52
- [Link To Text](2024-08-06-how-to-get-or-create-in-postgresql_raw.md)

## TL;DR
文章讨论了在PostgreSQL中实现"get or create"操作的方法，包括创建标签表、插入标签、提供幂等性、处理竞争条件、使用唯一约束违规、避免膨胀、理解子语句可见性、避免并发问题、优雅处理冲突、避免模式更改等。强调了唯一约束违规可能导致膨胀，`WITH`子句并发执行不保证完全一致性，`INSERT ON CONFLICT`需要唯一或排除约束，而`MERGE`不需要。

## Summary
1. **概述**：
   - "Get or create" 是在数据库中同步数据时非常常见的操作，但正确实现它可能比预期的要复杂。
   - 文章探讨了在PostgreSQL中实现"get or create"的方法。

2. **实现"Get or Create"**：
   - **创建标签表**：
     - 创建包含自增主键和名称的标签表，并添加名称的唯一约束。
   - **插入标签**：
     - 插入标签时，如果名称已存在，会触发唯一约束违规错误。

3. **提供幂等性**：
   - **检查并插入**：
     - 通过函数先检查标签是否存在，如果不存在则插入并返回。
     - 该函数可以处理单个或多个标签的插入。

4. **处理潜在的竞争条件**：
   - **捕获唯一约束违规**：
     - 通过捕获插入命令中的唯一约束违规异常来处理并发插入相同标签的情况。

5. **使用唯一约束违规**：
   - **直接插入并捕获违规**：
     - 直接尝试插入新标签，如果失败则查找并返回已存在的标签。
     - 这种方法在大多数标签是新标签时更高效。

6. **滥用唯一约束违规**：
   - **生成膨胀**：
     - 大量尝试插入已存在的标签会导致表膨胀，因为每次违规插入都会产生死元组。
     - 手动清理膨胀可以恢复表的原始大小。

7. **理解子语句可见性**：
   - **避免膨胀**：
     - 通过在插入前检查标签是否存在来避免触发唯一约束违规。
     - 使用`WITH`子句插入新标签，并在主查询中获取新旧标签。

8. **避免并发问题**：
   - **并发测试**：
     - 并发执行插入随机标签的脚本会导致唯一约束违规错误。
     - 这表明在单个查询中也可能发生时间检查到使用（TOC-TOU）问题。

9. **优雅地处理冲突**：
   - **使用`ON CONFLICT`子句**：
     - 使用`ON CONFLICT`子句处理插入时的冲突，避免膨胀和并发问题。
     - 这种方法在并发执行时安全且不会生成膨胀。

10. **走错路**：
    - **无意义的更新**：
      - 尝试通过无意义的更新来“影响”已存在的行，使其返回。
      - 这种方法会导致膨胀，因为每次更新都会产生死元组。

11. **避免模式更改**：
    - **使用`MERGE`语句**：
      - `MERGE`语句不需要目标表上的唯一或排除约束。
      - 从PostgreSQL 17开始，`MERGE`语句支持`RETURNING`子句。

12. **总结**：
    - **比较不同方法**：
      - 总结了不同方法在幂等性、并发性、膨胀和约束要求方面的表现。
    - **要点**：
      - 唯一约束违规可能导致膨胀。
      - `WITH`子句并发执行，不保证完全一致性。
      - `INSERT ON CONFLICT`需要唯一或排除约束，而`MERGE`不需要。
