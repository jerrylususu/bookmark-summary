# Web 端实时防挡脸弹幕（基于机器学习） | 风痕 · 術&思
- URL: https://hughfenghen.github.io/posts/2023/06/21/body-mask-danmaku/
- Added At: 2024-08-13 14:46:22

## TL;DR
本文介绍了防挡弹幕的实现原理，通过机器学习库实时提取视频中的人像区域，优化弹幕显示效果。经过多次调优，成功将CPU占用从70%降低至5%，并提供了兼容性和性能优化的注意事项。

## Summary
1. **防挡弹幕简介**
   - 防挡弹幕是一种弹幕效果，弹幕不会遮挡视频画面中的人物，看起来像是从人物背后飘过去的。

2. **前言**
   - 介绍mediapipe示例，展示机器学习在前端实现的可能性，旨在打破“前端无法实现机器学习能力”的思维禁区。

3. **主流实现原理介绍**
   - **点播**：
     1. up主上传视频
     2. 服务器后台计算提取视频画面中的人像区域，转换成svg存储
     3. 客户端播放视频的同时，从服务器下载svg与弹幕合成，人像区域不显示弹幕
   - **直播**：
     1. 主播推流时，实时从画面提取人像区域，转换成svg
     2. 将svg数据合并到视频流中（SEI），推流至服务器
     3. 客户端播放视频同时，从视频流中（SEI）解析出svg
     4. 将svg与弹幕合成，人像区域不显示弹幕

4. **本文实现方案**
   - **实现原理**：
     1. 客户端播放视频同时，实时从画面提取人像区域信息
     2. 将人像区域信息导出成图片，与弹幕合成，人像区域不显示弹幕
   - **具体步骤**：
     1. 采用机器学习开源库从视频画面实时提取人像轮廓
     2. 将人像轮廓转导出为图片，设置弹幕层的mask-image

5. **面临的问题**
   - JS性能问题，CPU密集型任务的挑战
   - 通过优化，将CPU占用优化到5%左右（2020 M1 Macbook）

6. **调优过程**
   - **选择机器学习模型**：
     1. BodyPix：精确度差，弹幕与面部重合
     2. BlazePose：精确度与MediaPipe SelfieSegmentation相近，CPU占用高
     3. MediaPipe SelfieSegmentation：精确度优秀，性能取胜
   - **降低提取频率，平衡性能-体验**：
     1. 将弹幕遮罩（Mask）刷新频率降为15FPS，CPU占用50%左右
   - **解决性能瓶颈代码**：
     1. 重写toBinaryMask，CPU占用33%左右
     2. 多线程优化，CPU占用15%左右
   - **降低分辨率**：
     1. 降低给推理模型的图像的分辨率，减少计算量，CPU占用5%左右
   - **启动条件优化**：
     1. 画面无人时，CPU占用接近0%

7. **发布构建优化**
   - 异步加载SDK，提升页面加载性能

8. **总结**
   - **过程**：
     1. 初始状态CPU 70%
     2. 降低Mask刷新频率（15FPS），CPU 50%
     3. 重写开源库实现（toBinaryMask），CPU 33%
     4. 多线程优化，CPU 15%
     5. 降低分辨率，CPU 5%
     6. 判断画面是否有人，无人时CPU接近0%
   - **注意事项**：
     1. 兼容性：Chrome 79及以上，不支持Firefox、Safari
     2. 不应创建多个或多次创建segmenter实例
   - **经验**：
     1. 结合业务场景特征进行分析优化
     2. 性能优化需要业务场景分析
     3. 关注WebNN、WebGPU的进展和应用
