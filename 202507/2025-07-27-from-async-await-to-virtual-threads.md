# From Async/Await to Virtual Threads
- URL: https://lucumr.pocoo.org/2025/7/26/virtual-threads/
- Added At: 2025-07-27 14:03:58
- [Link To Text](2025-07-27-from-async-await-to-virtual-threads_raw.md)

## TL;DR


本文提出虚拟线程结合结构化并发可简化Python并发编程，替代异步与线程双系统带来的复杂度。通过轻量级线程自动管理和显式API（如ThreadGroup），强制结构化任务依赖以避免资源泄漏，但需解决Python语法适配及运行时复杂性，未来或逐步取代async/await，提升开发体验。（99字）

## Summary


- **背景与现状分析**  
  - `async/await`提高了并发编程的普及，但需要复杂的底层机制及「颜色函数」（区分普通函数与协程函数），增加了代码复杂度。  
  - 传统线程API存在不足，但其模型比异步编程更直观；而Python当前同时维护两套系统（异步和线程），导致开发复杂度叠加。  

- **结构化虚拟线程的提出**  
  - 强调「结构化并发」的重要性：强制子任务不能脱离父任务存活，确保资源释放与上下文传播。  
  - 现有任务组（如Python）的取消机制不足，导致外部库（如`aiofiles`）易引发死锁或异常不可见等问题。  

- **虚拟线程的潜在改进**  
  - **简化编程模型**：通过虚拟线程与结构化并发结合，替代异步编程语法。  
    - 示例代码演示以线程组批量下载URL，无需显式处理`Future`或Promise。  
    - **虚拟线程特性**：轻量级、基于内核线程调度，支持自动挂起与恢复，由运行时管理。  
  - **显式API设计**：如在`ThreadGroup`中显式启动子任务，支持并发限制（`max_concurrency`参数）、资源互斥（`Mutex`封装）等。  

- **实施挑战与权衡**  
  - **Python适配问题**：语法设计需考虑作用域与闭包限制，隐式线程组（类似`asyncio`的`Nursery`）可能更合适。  
  - **复杂性下放**：运行时需内置取消信号、I/O阻塞处理等逻辑，隐藏底层细节。  

- **对async/await的未来展望**  
  - 新代码可能不再需要`async/await`，但现有异步代码需兼容。  
  - 虚拟线程简化模型，避免「颜色函数」等复杂概念，但具体实现细节需进一步探索。  

- **总结观点**  
  虚拟线程结合结构化并发能简化并发编程，减少异步与多线程系统的复杂性叠加，提升开发者体验，需在Python语言特性与运行时机制中验证可行性。
