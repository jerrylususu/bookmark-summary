# So you want to serialize some DER? · Alex Gaynor
- URL: https://alexgaynor.net/2025/jun/20/serialize-some-der/
- Added At: 2025-07-01 15:11:30
- [Link To Text](2025-07-01-so-you-want-to-serialize-some-der-·-alex-gaynor_raw.md)

## TL;DR


文章分析了ASN.1的DER编码在长TLV序列化中因动态长度字段导致的性能问题。早期的`rust-asn1`库通过回填优化内存，但长数据仍需重复操作。作者改用位运算预计算长度后，发现LLVM的汇编冗余，借助Alive2验证并借助AI模型Claude生成补丁优化汇编代码。最终优化策略被LLVM采纳，证明了AI与形式化工具结合在编译器优化中的潜力，同时需开发者严格审验代码。

## Summary


1. 文章从ASN.1及其编码格式DER的特性入手，解释了其基于TLV（类型-长度-值）的二进制结构，其中长度字段是可变长度编码，导致序列化时需要动态预留空间或后期调整。

2. 对于作者维护的Rust库`rust-asn1`，早期序列化实现通过预留1字节长度的方式，先写入值再计算实际长度并回填或重排，虽然在多数短TLV场景下可行，但对于长数据会引发多次内存复制操作，存在性能缺陷。

3. 作者提出改进方案，要求值类型预先声明长度以避免重复写入，但整数类型（如INTEGER）的长度预计算需要处理二进制位数与字节长度的转换逻辑。原解法依赖循环计算字节数，新方案改用位运算和分支判断精简逻辑，虽然代码更复杂但优化了运算效率。

4. 在尝试进一步优化时，作者发现即使新方案生成的LLVM汇编代码存在冗余指令，例如`(bits_needed).div_ceil(8)`在编译后需要多条CPU指令实现。通过Alive2形式验证工具，验证了存在更高效的IR（中间语言）转换路径。

5. 作者将优化需求委托给第三方模型Claude，提供具体IR代码和预期优化结果。模型最终生成测试案例和补丁，成功修复LLVM优化器的汇编生成策略，并通过维持审验证确认代码正确性，最终合并到LLVM项目。

6. 总结关键经验：a) 对明确目标的代码优化问题，模型即使看似不可行也可能带来惊喜；b) LLM与形式验证工具结合可有效推导和验证优化路径；c) 编译器优化仍有大量潜力，即使是在技术成熟的当前。

7. 隐含启示包括：开发者在使用AI辅助开发时需具备代码审查能力，避免盲目信任输出结果；模型化的优化流程可能为编译器改进提供新的协作模式。
