# AI代理的上下文工程：构建Manus的经验教训
- URL: https://manus.im/blog/Context-Engineering-for-AI-Agents-Lessons-from-Building-Manus
- Added At: 2025-07-21 14:12:18
- [Link To Text](2025-07-21-ai代理的上下文工程：构建manus的经验教训_raw.md)

## TL;DR


本文总结构建AI代理Manus的上下文工程经验，提出六大核心策略：  
① **以工程替代模型训练**，实现快速迭代；  
② **KV缓存优化**采用稳定前缀和追加式设计，提升性能；  
③ **状态机控制工具选择**，避免工具爆炸与缓存失效；  
④ **文件系统存储外部记忆**，压缩上下文负载；  
⑤ **复述关键任务+保留错误**增强注意力与容错性；  
⑥ **多样化动作格式**防止模式固化。这些原则通过系统性设计显著提升了代理效率与灵活性。

## Summary


本文总结了构建AI代理Manus时学到的上下文工程实践，重点围绕以下核心原则与技术策略：

---

### **上下文工程的核心决策**
1. **选择上下文工程而非模型训练**  
   - 快速迭代：避免耗时的端到端模型训练，依赖前沿模型的上下文学习能力，实现小时级而非周级的反馈循环。  
   - 灵活性：与基础模型解耦，作为“船”而非“固定支柱”，适应模型快速更新。

---

### **设计围绕KV缓存**
1. **关键指标**：KV缓存命中率直接影响延迟和成本（如Claude Sonnet缓存成本降低10倍）。  
2. **优化策略**：  
   - **稳定前缀**：固定系统提示开头，避免动态内容（如时间戳）破坏缓存。  
   - **追加式上下文**：仅追加新动作与观察，避免修改历史记录；确保JSON序列化顺序可预测。  
   - **手动设置断点**：在框架不支持自动缓存时，插入断点以最小化缓存失效范围。  
3. **技术保障**：启用prefix caching（如vLLM），通过session ID保证分布式服务一致性。

---

### **屏蔽工具而非动态调整**
1. **问题**：工具空间爆炸导致选择混乱、缓存失效及模型混淆。  
2. **解决方案**：  
   - **状态机控制工具可用性**：通过logits掩码动态屏蔽或强制选择特定工具（如浏览器、命令行前缀）。  
   - **约束解码模式**：强制/限制动作选择，通过前缀填充实现（如“browser_”开头限定工具组）。  
   - 避免动态增减工具，减少上下文扰动。

---

### **文件系统作为外部记忆**
1. **应对长上下文挑战**：  
   - 观察数据量过大、模型长距依赖性能下降、成本攀升问题。  
2. **实践方法**：  
   - **持久化存储**：将大文件、网页内容等写入代理沙盒，使模型仅保留路径而非完整内容。  
   - **可恢复压缩**：保留关键元数据（如URL、文件路径）以恢复信息，减少上下文负载。  
   - **未来方向**：探索基于文件系统的State Space Model（SSM），实现高速、轻量的代理。

---

### **注意力操控与错误利用**
1. **复述技术增强专注力**：  
   - 自动创建并更新todo.md文件，将任务分解为步骤清单，维持模型对全局目标的注意力。  
2. **保留错误记录**：  
   - 错误提示、堆栈信息等保留于上下文，避免信息流失；模型通过观察失败案例调整策略，减少重复错误。  

---

### **避免模式固化**
1. **问题**：相似动作-观察记录导致过度拟合（如重复简历审阅动作）。  
2. **解决方法**：  
   - **引入多样化**：调整动作序列的格式、顺序或措辞（如交替使用不同的JSON模板），打破重复模式。

---

### **结论**
上下文工程是构建高效代理的核心，涉及记忆、环境交互与反馈的系统性优化。Manus的经验表明：  
- **缓存与工具控制**提升性能与成本效益；  
- **外部存储与动态调整**解决长上下文问题；  
- **错误保留与多样化**增强容错与灵活性。  
这些原则需结合具体场景迭代实践，是构建智能代理的基础框架。
