# Bash Strict Mode
- URL: http://redsymbol.net/articles/unofficial-bash-strict-mode/
- Added At: 2024-12-01 07:51:39
- [Link To Text](2024-12-01-bash-strict-mode_raw.md)

## TL;DR
Bash Strict Mode通过`set -euo pipefail`和`IFS=$'\n\t'`设置，使脚本在遇到错误时立即失败，提高可靠性和可维护性。常见问题如未定义变量、非零退出状态等有相应解决方案，使用该模式可减少调试时间并避免生产环境中的意外问题。

## Summary
1. **Bash Strict Mode简介**：
   - 通过在脚本开头添加特定设置，可以使Bash脚本更加健壮、可靠和易于维护。
   - 这些设置包括：`set -euo pipefail` 和 `IFS=$'\n\t'`。
   - 这些设置会导致脚本在遇到某些常见错误时立即失败，从而避免隐藏的错误在生产环境中爆发。

2. **set命令详解**：
   - `set -e`：脚本中任何命令的非零退出状态都会导致脚本立即退出。
   - `set -u`：引用未定义的变量会导致脚本立即退出，除了`$*`和`$@`。
   - `set -o pipefail`：防止管道中的错误被掩盖，整个管道的返回码为最后一个失败的命令的返回码。

3. **IFS设置**：
   - IFS（Internal Field Separator）控制Bash的单词分割。
   - 默认的IFS值可能导致意外的单词分割，特别是在处理包含空格的文件名或数组时。
   - 将IFS设置为`$'\n\t'`可以减少这种意外行为，特别是在迭代数组时。

4. **常见问题与解决方案**：
   - **非合规文档的源码加载**：如果需要加载不兼容的文档，可以临时禁用`set -u`，加载后再重新启用。
   - **位置参数处理**：使用参数默认值语法`${VARNAME:-DEFAULT_VALUE}`来处理未提供的位置参数。
   - **有意未定义的变量**：在脚本开头显式设置变量为空字符串，以避免未定义变量的引用。
   - **预期非零退出状态的命令**：使用`|| true`来确保命令失败时脚本不会退出，或者临时禁用`set -e`。
   - **必要的清理工作**：使用Bash退出陷阱（exit traps）来确保在脚本退出时执行清理操作，无论是因为错误还是正常完成。
   - **短路操作的注意事项**：在短路操作中，特别是作为脚本的最后一行时，可能会导致意外的非零退出状态，建议使用完整的if语句来替代短路操作。

5. **总结**：
   - Bash Strict Mode通过强制脚本在遇到错误时立即失败，提高了脚本的可靠性和可维护性。
   - 尽管这些设置可能会使某些常见的Bash习惯用法变得更难使用，但大多数问题都有简单的解决方法。
   - 使用Bash Strict Mode可以显著减少调试时间，并避免在生产环境中出现意外的复杂问题。
