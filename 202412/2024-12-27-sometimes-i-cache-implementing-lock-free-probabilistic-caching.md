# Sometimes I cache: implementing lock-free probabilistic caching
- URL: https://blog.cloudflare.com/sometimes-i-cache/
- Added At: 2024-12-27 14:25:49
- [Link To Text](2024-12-27-sometimes-i-cache-implementing-lock-free-probabilistic-caching_raw.md)

## TL;DR
HTTP缓存通过缓存锁或概率性重新验证来防止缓存雪崩问题。概率性方法通过模拟掷骰子决定是否请求源服务器，减少延迟和故障风险，但无法保证确定性。最优解决方案基于指数分布的概率函数，适用于高性能缓存场景。实际应用中，概率性方法在特定场景下表现优异，鼓励开发者探索其实现。

## Summary
1. **HTTP缓存基础**：
   - **概念**：HTTP缓存的基本原理是，如果请求的响应在缓存中，则直接返回；否则，从源服务器获取响应，存入缓存并返回。
   - **缓存重新验证**：当缓存过期时，为了防止源服务器被大量请求淹没，通常会使用缓存锁来保护源服务器。

2. **缓存雪崩问题**：
   - **场景**：以在线图片库为例，当缓存过期时，大量请求同时涌向源服务器，导致服务器过载。
   - **解决方案**：通过缓存锁或概率性缓存重新验证来缓解这一问题。

3. **概率性缓存重新验证**：
   - **核心思想**：通过模拟掷骰子的方式，决定是否将请求发送到源服务器。例如，只有掷出6时才发送请求，否则继续使用过期的缓存。
   - **优点**：无需依赖外部服务，减少延迟和故障风险。
   - **缺点**：无法保证请求数量的确定性，可能出现极端情况。

4. **缓存锁的局限性**：
   - **延迟和故障**：缓存锁需要与外部服务通信，增加了延迟和故障的可能性。
   - **确定性**：缓存锁是确定性的，适用于大多数场景，但概率性方法在某些情况下更具优势。

5. **概率性方法的实现**：
   - **基本实现**：通过设置概率值（如1/10），减少发送到源服务器的请求数量。
   - **期望值计算**：使用数学公式计算请求发送的期望值，确保在缓存过期前完成重新验证。
   - **自适应概率**：根据请求速率动态调整概率值，确保在不同请求速率下都能有效保护源服务器。

6. **最优缓存雪崩解决方案**：
   - **学术参考**：参考了2015年的一篇学术论文《Optimal Probabilistic Cache Stampede Prevention》，提出了基于指数分布的概率函数。
   - **连续概率函数**：使用连续的概率函数$p(t)=e^{-\lambda (expiry-t)}$，替代离散的概率值，进一步优化缓存重新验证。

7. **实际应用**：
   - **代码实现**：提供了多个代码片段，展示了如何在Cloudflare Workers中实现概率性缓存重新验证。
   - **生产环境**：在需要高性能缓存且无法使用内置缓存机制的场景下，概率性缓存雪崩预防方法表现良好。

8. **总结**：
   - **适用场景**：在大多数情况下，缓存锁已经足够应对缓存雪崩问题，但在某些特定场景下，概率性方法更具优势。
   - **实验与探索**：鼓励读者在Cloudflare Workers Playground中尝试提供的代码片段，进一步探索概率性缓存重新验证的实现。
