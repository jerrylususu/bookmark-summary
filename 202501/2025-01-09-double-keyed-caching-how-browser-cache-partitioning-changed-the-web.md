# Double-keyed Caching: How Browser Cache Partitioning Changed the Web
- URL: https://addyosmani.com/blog/double-keyed-caching/
- Added At: 2025-01-09 13:41:59
- [Link To Text](2025-01-09-double-keyed-caching-how-browser-cache-partitioning-changed-the-web_raw.md)

## TL;DR
双键缓存模型通过引入顶级站点和资源URL作为缓存键，有效防止跨站点跟踪和隐私泄露，但导致缓存命中率下降和网络带宽增加。为应对这一变化，建议优化域名策略、自托管关键资源、调整包边界与域边界对齐，并实施性能监控。尽管带来性能成本，双键缓存是网络隐私演变的必要步骤，未来需平衡隐私与性能。

## Summary
1. **缓存模型变化**：
   - **传统缓存模型**：浏览器使用简单的键值对存储缓存资源，允许跨站点资源共享，减少带宽使用，提高性能。
   - **双键缓存模型**：引入双键缓存，缓存键由请求的顶级站点和资源URL组成，防止跨站点跟踪和隐私泄露。

2. **隐私问题**：
   - **缓存探测**：站点A可以检查站点B的资源是否在缓存中，泄露浏览历史。
   - **时间攻击**：通过测量资源加载时间暴露缓存状态。
   - **跨站点跟踪**：缓存资源可用作持久标识符。

3. **双键缓存的影响**：
   - **缓存命中率下降**：整体缓存未命中率增加3.6%，网络加载字节增加4%，首次内容绘制（FCP）影响0.3%。
   - **安全优势**：防止时间攻击、跨站点跟踪、侧信道攻击和跨站点搜索攻击。

4. **网络带宽影响**：
   - **共享库**：如jQuery或React等流行JavaScript库需要单独下载，增加带宽使用。
   - **Web字体**：如Google Fonts的常见字体需要多次下载，增加带宽成本。
   - **大资源**：如机器学习模型等大资源影响最显著，可能需要多次下载，增加CDN成本。

5. **性能影响示例**：
   - **企业SaaS套件**：共享库在不同子域名下需要多次缓存，增加总缓存使用量。
   - **流行框架CDN**：如React等框架在不同站点下需要多次缓存。
   - **微前端影响**：React微前端在不同子域名下需要重复下载React。

6. **实际影响**：
   - **CDN经济变化**：公共CDN的使用需要重新考虑，自托管可能更高效。
   - **域名策略**：每个子域名维护单独的缓存，域名合并有性能优势。
   - **包策略更新**：较小的、集中的包可能比共享块更可取，代码拆分边界应与域边界对齐。

7. **适应策略**：
   - **域名合并**：考虑使用统一的静态域名来减少缓存分区的影响。
   - **智能资源加载**：自托管关键资源，减少对公共CDN的依赖。
   - **模块联邦**：使用Webpack的模块联邦插件来共享依赖。

8. **浏览器差异**：
   - **Chrome**：使用顶级站点+框架站点。
   - **Safari**：使用顶级eTLD+1。
   - **Firefox**：计划使用顶级scheme://eTLD+1。

9. **推荐行动**：
   - **立即行动**：审计域名策略，测量实际缓存命中率，考虑自托管关键资源。
   - **架构更新**：对齐包边界与域边界，实施稳健的性能监控，战略性地使用资源提示。
   - **长期规划**：在架构决策中考虑缓存分区，计划增加带宽成本。

10. **特殊资源考虑**：
    - **模型加载**：跨不同来源访问的模型加载时间增加，带宽成本增加，可能影响应用程序初始化时间。
    - **优化方法**：模型拆分和渐进加载，使用共享基础模型与差异更新，在应用程序级别实施模型缓存策略。

11. **未来路径**：
    - **缓存分区**：代表网络隐私的必要演变，但带来真实的性能成本。解决方案是适应我们的架构和优化策略。
    - **网络平台演变**：新的API和模式将出现，帮助平衡隐私与性能。在此之前，谨慎的域名策略和资源管理仍然是优化性能的最佳工具。
