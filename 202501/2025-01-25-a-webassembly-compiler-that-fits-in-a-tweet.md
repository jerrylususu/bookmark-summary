# A WebAssembly compiler that fits in a tweet
- URL: https://wasmgroundup.com/blog/wasm-compiler-in-a-tweet/
- Added At: 2025-01-25 21:24:06

## TL;DR
该项目通过JavaScript实现了一个极简的WebAssembly编译器，将逆波兰表示法的算术表达式编译为WebAssembly模块。通过一系列代码优化技巧，编译器从最初的269字节优化至192字节。文章详细解析了优化过程、隐式设计决策以及未实现的优化技巧，并推荐了相关学习资源。最终，项目不仅展示了WebAssembly的内部机制，还为未来改进提供了方向。

## Summary
1. **项目背景**：
   - 该项目旨在探索如何用JavaScript实现一个极简的WebAssembly编译器，最初的版本为269字节，最终优化至192字节。
   - 编译器将逆波兰表示法的算术表达式编译为有效的WebAssembly模块，并导出一个返回表达式结果的函数。

2. **编译器核心代码**：
   - 核心代码通过`WebAssembly.instantiate`和`Int8Array`生成WebAssembly模块。
   - 示例代码展示了如何使用该编译器计算表达式`11 11 1 - + 4 * 2 /`。

3. **代码优化技巧**：
   - **格式化代码**：通过格式化代码使其更易读，但仍保持紧凑。
   - **移除赋值表达式**：将赋值表达式拆分为多行，避免使用单行表达式。
   - **变量命名优化**：将单字母变量替换为更具描述性的名称，并避免变量重用。
   - **稀疏数组优化**：通过省略数组中的0值来节省字节，最终恢复所有0值。
   - **长度计算优化**：通过变量`len`避免重复计算字节长度。
   - **模板字符串优化**：将模板字符串替换为普通函数调用。
   - **三元运算符优化**：将三元运算符替换为`if`语句。
   - **数字检查优化**：显式解析数字并检查其有效性，支持负数输入。
   - **indexOf优化**：移除`indexOf`的`-1`技巧，直接映射操作符到字节码。
   - **操作符映射优化**：使用对象映射操作符到字节码，避免`indexOf`技巧。
   - **导出名称优化**：将空字符串导出名称替换为`a`，节省字节并提高可读性。

4. **隐式设计决策**：
   - 编译器仅支持7位数字编码（0到63），超出范围会导致错误。
   - 未实现完整的LEB128编码算法，限制了数字的范围。

5. **未实现的优化技巧**：
   - 曾尝试通过字符编码简化操作符映射，但因UTF-8和WebAssembly字节码顺序不一致而失败。

6. **字节数组解析**：
   - 详细解释了用于构建WebAssembly模块的字节数组的各个部分，包括模块魔数、版本号、类型段、函数段、导出段和代码段。

7. **总结**：
   - 通过逐步优化和解析，将192字节的代码片段转化为更易读的形式，并深入理解了WebAssembly的内部机制。
   - 如果放宽大小限制，可以进一步改进编译器，例如支持更大的数字、更友好的语法、条件语句和循环等。

8. **推荐资源**：
   - 推荐阅读《WebAssembly from the Ground Up》一书，深入了解WebAssembly并编写一个简单的编译器。

9. **致谢**：
   - 特别感谢lexi贡献了部分优化技巧。
