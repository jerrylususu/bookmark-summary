# Timeouts and cancellation for humans — njs blog
- URL: https://vorpus.org/blog/timeouts-and-cancellation-for-humans/
- Added At: 2025-01-14 14:45:54

## TL;DR
文章讨论了在处理外部系统交互时，超时和取消机制的重要性及其挑战。传统的超时处理方法存在局限性，而Trio库提出的取消范围（Cancel Scopes）机制通过自动化传递取消令牌，简化了代码复杂性，提升了可靠性和可维护性。该机制适用于同步单线程Python、asyncio及其他编程语言，为超时和取消处理提供了创新解决方案。

## Summary
1. **问题背景**：
   - **外部世界不可靠**：即使代码完美无缺，外部系统（如网络、打印机等）可能崩溃或冻结，导致代码挂起。
   - **超时需求**：每次与外部系统交互时，必须考虑超时，否则可能导致潜在的错误。

2. **超时处理的挑战**：
   - **简单超时的局限性**：简单的超时参数不支持抽象，导致在多层抽象中难以正确传递超时。
   - **绝对截止时间的优缺点**：
     - **优点**：绝对截止时间在库内部易于传递，简化了实现。
     - **缺点**：用户需要手动计算截止时间，增加了使用复杂性。

3. **取消令牌（Cancel Tokens）**：
   - **封装取消状态**：取消令牌封装了取消条件，支持任意取消操作，而不仅仅是超时。
   - **级别触发与范围匹配**：
     - **级别触发**：取消令牌是级别触发的，避免了边缘触发API的常见问题。
     - **范围匹配**：取消令牌的范围可以灵活匹配程序需求，支持复杂任务的取消。
   - **实际不可靠性**：由于人类容易忽略传递取消令牌，导致在实际应用中不可靠。

4. **Trio的解决方案：取消范围（Cancel Scopes）**：
   - **工作原理**：通过`with`块创建取消范围，自动将取消令牌应用于块内的所有阻塞操作。
   - **嵌套支持**：取消范围支持嵌套，确保内部超时不会影响外部超时。
   - **取消检查点**：Trio通过`async/await`语法明确标记阻塞点，确保取消异常在合适的地方被捕获。

5. **取消范围的优点**：
   - **自动化传递**：取消范围自动将取消令牌传递给所有子操作，减少了人为错误。
   - **简化代码**：用户无需手动传递取消令牌，代码更加简洁。
   - **支持复杂操作**：取消范围支持复杂操作的超时和取消，如并行连接尝试。

6. **适用场景**：
   - **同步单线程Python**：取消范围可以应用于同步单线程Python代码，简化超时和取消处理。
   - **asyncio**：Trio的取消范围机制可以借鉴到asyncio中，提升其超时和取消处理的易用性。
   - **其他语言**：取消范围的设计思想可以推广到其他编程语言，提升超时和取消处理的通用性。

7. **总结**：
   - **超时和取消的重要性**：超时和取消处理是编写健壮代码的关键，尤其是在与外部系统交互时。
   - **取消范围的创新**：Trio的取消范围机制通过自动化传递取消令牌，简化了超时和取消处理的复杂性，提升了代码的可靠性和可维护性。
