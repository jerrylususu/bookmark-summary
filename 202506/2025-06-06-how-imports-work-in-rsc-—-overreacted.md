# How Imports Work in RSC — overreacted
- URL: https://overreacted.io/how-imports-work-in-rsc/
- Added At: 2025-06-06 14:07:56
- [Link To Text](2025-06-06-how-imports-work-in-rsc-—-overreacted_raw.md)

## TL;DR


React Server Components（RSC）通过独立前后端模块系统和毒药药片机制（如'server-only'、'client-only'）确保代码环境安全，结合'use client'/'use server'指令实现跨端通信。未标记模块默认双向复用，执行边界由导入语义动态判定，最终实现单一代码库高效管理复杂应用，同时避免逻辑污染与重复。

## Summary


React Server Components（RSC）通过扩展模块系统的语义，允许开发者将客户端与服务端代码统一编写为一个程序。其核心机制包括：

1. **模块系统基础**  
   JavaScript模块通过`import/export`实现代码分割，确保每个模块**单例运行**（无论被导入多少次，代码仅执行一次）。模块系统本质上将多个文件“展开”为单一程序，但通过缓存机制避免重复执行。

2. **前后端环境的独立模块系统**  
   服务端和客户端代码分别独立运行，各自拥有独立的模块缓存。共享代码在两端被**重复导入**，形成独立实例。例如：  
   - 若服务端模块A导入模块C，客户端模块B也导入模块C，则C在两端各执行一次，互不干扰。

3. **代码复用风险与解决方案**  
   - **污染风险**：未受控的代码共享可能导致逻辑错误或安全漏洞（如服务端敏感代码泄露到客户端）。  
   - **毒药药片机制**：  
     - `import 'server-only'`：标记仅服务端可用的模块，当其被客户端导入时，触发构建错误。  
     - `import 'client-only'`：反向约束，防止客户端代码进入服务端。  
   - 这些机制通过**传播感染**实现防御：若模块A依赖server-only的模块B，则A自动被标记为服务端专用。

4. **跨环境引用：use client和use server指令**  
   - `'use client'`：标记组件为客户端独占，允许服务端代码**引用**但不复制其代码。服务端渲染时会自动生成对应的`<script>`标签，将组件传递到客户端执行。  
   - `'use server'`：反向机制，使客户端代码安全引用服务端功能。

5. **整体架构**  
   RSC保留服务端与客户端独立的模块系统，通过以下方式整合：  
   - **毒药药片**：防止不当代码污染。  
   - **指令语义**：在需要跨环境通信时创建“通道”。  
   - **默认行为**：未标记模块默认可双向复用，仅在需要时通过指令或约束锁定环境。

这一设计使复杂应用能以单一代码库形式管理，同时通过显式标记和约束确保安全性和执行效率。最终，模块间的可见性和执行边界由导入语义和约束机制动态决定，而非静态目录划分。
