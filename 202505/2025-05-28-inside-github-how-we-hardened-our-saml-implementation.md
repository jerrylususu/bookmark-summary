# Inside GitHub: How we hardened our SAML implementation
- URL: https://github.blog/security/web-application-security/inside-github-how-we-hardened-our-saml-implementation/
- Added At: 2025-05-28 14:12:07
- [Link To Text](2025-05-28-inside-github-how-we-hardened-our-saml-implementation_raw.md)

## TL;DR


GitHub为提升企业级SAML单点登录的安全性，采取四阶段措施：首先采用并深度审计社区开源库，替换风险代码；其次通过A/B测试确保兼容性；接着定制严格Schema缩小攻击面；最后实施双解析库机制实现冗余校验。这些优化使系统日均处理百万级请求仍保持安全，验证了系统性重构、渐进验证及多层防御对高复杂度代码模块的有效性。

## Summary


GitHub自2014年推出企业级SAML单点登录（SSO）功能以来，相关代码因涉及XML解析与复杂加密逻辑，长期面临高安全风险。为此，工程团队实施了以下四阶段措施强化SAML实现：

### 1. **库的选择与深度审计**
GitHub放弃自研的内部SAML实现，改用社区活跃的**ruby-saml**开源库。通过多方协作（安全团队、漏洞奖励项目研究员、GitHub Security Lab），团队针对新库开展全面审计，定位并修复潜在漏洞，例如发现签发者验证空白值缺陷，并针对历史遗留配置兼容性优化集成。利用GitHub Advisory Database和Dependabot工具确保库的安全更新及时同步。

### 2. **A/B测试验证新库**
借助开源工具**Scientist**实现代码实验对比：控制组为原有逻辑，候选组使用新库。通过流量比对监控、补充日志记录与状态隔离技术，逐级释放测试流量。例如，首次发现3%的认证验证差异源于签发者空白值配置问题，通过限制库中开发者字段的空值验证，解决了兼容性偏差，并最终验证新库能稳定处理全量流量。

### 3. **严格Schema验证缩小攻击面**
根据实际生产数据与主流身份提供商（如Azure Entra、Okta）的响应结构，定制**限定版SAML Schema**。关键措施包括：
- **签名位置禁用**：确保Signature仅出现在Response或Assertion节点，防止嵌套签名导致的验证绕过。
- **单一断言强制**：要求每个响应包含恰好一个Assertion，排除协议允许多数的混乱结构。
- **剔除冗余元素**：移除未被实际使用的“任意”占位符元素（如StatusDetail中的附加标签），完全禁用过时的DTD支持。
- **精确数据约束**：按真实流量逐项裁剪Schema，扩展时保留最小必要结构，减少解析歧义点。

### 4. **双库解析抵消漏洞影响**
为避免依赖单一库的安全风险，GitHub采用**双解析机制**：新旧两版SAML解析库并行处理相同响应，只有两者一致验证通过时才允许用户认证。这一设计优势在于：
- **多层防御**：不同库逻辑的差异使攻击者需同时利用两者的漏洞。
- **动态反馈**：差异告警促进团队及时排查潜在边缘情况。
- **平滑过渡**：原有库作为可靠控制组，不中断当前流程并逐步验证新库可靠性。

### 结果与启示
通过持续流量监测与数据驱动的优化策略，GitHub的SAML实现日均处理百万量级请求时仍保持安全性。核心经验包括：
- 面对复杂技术（如SAML）的安全加固需系统性重构，而非单一漏洞修补。
- A/B测试与渐进式验证是高风险代码迁移的关键保障。
- 通过最小化输入验证结构与冗余防御策略（如双解析），显著降低攻击成功概率与漏洞影响范围。

该实践为安全团队提供参考框架：在处理复杂、高风险的代码模块时，数据驱动的迭代实验与防御深度的结合能有效提升安全性与长期维护效率。
