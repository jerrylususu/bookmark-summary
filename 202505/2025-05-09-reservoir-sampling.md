# Reservoir Sampling
- URL: https://samwho.dev/reservoir-sampling/
- Added At: 2025-05-09 14:03:10
- [Link To Text](2025-05-09-reservoir-sampling_raw.md)

## TL;DR


水库抽样是一种在数据流中实现公平抽样的算法，适用于未知数据总量的场景。其核心是对第`n`个元素以`1/n`（抽1个）或`k/n`（抽`k`个）的概率动态替换已有样本，确保每个元素被选中的概率均等。该算法内存恒定，常用于日志服务等需实时处理且限制存储的场景，在流量平稳时保留全部数据，高峰时丢弃冗余信息，但存在分块传输的时延缺陷。实际应用需结合加权或优先级规则，以应对复杂需求。

## Summary


本文介绍了水库抽样的原理、应用场景及实现方法。主要分为以下部分：  

1. **已知数据集大小的抽样**  
   - 当已知集合大小时，可通过随机索引直接选取元素，或通过洗牌后取前N项。  
   - 示例：从10张牌中选3张，可通过随机索引或洗牌后取前3张，两种方法概率均等。  

2. **未知数据集大小的抽样**  
   - 问题背景：需实时处理连续数据流，且无法存储所有数据。例如日志服务在流量激增时需限制传输量。  
   - 算法核心：  
     * 对第`n`个新元素，以概率`1/n`替换当前持有的元素。  
     * 验证公平性：通过概率公式推导，每张牌最终被选中的概率均为`1/N`（N为总元素数）。  
     * 例如：第1张牌保留概率为`1*(1-1/2)*(1-1/3)*…*(1-1/N) = 1/N`。  

3. **多元素抽样扩展**  
   - 需要选择`k`个元素时：对第`n`个元素，以概率`k/n`决定是否替换。  
   - 实现方法：维持`k`元素数组，生成随机数`0~n`，若小于`k`则替换对应位置元素。  

4. **在日志服务中的应用**  
   - 设置每秒最大传输量阈值（如5条），使用水库抽样选取日志。  
   - 优点：  
     * 平稳期保留所有日志，高峰期丢弃冗余数据。  
     * 内存使用恒定（仅存储`k`条样本）。  
   - 缺点：日志按时间段分块传输，非实时流式传输。  

5. **扩展与注意事项**  
   - 加权抽样：存在按权重调整概率的变种算法，但实现复杂。  
   - 实际场景需区分优先级（如保留所有错误日志）。  

6. **总结**  
   - 水库抽样在数据流处理中提供高效、公平的抽样方案，尤其适用于内存受限或实时决策场景。
