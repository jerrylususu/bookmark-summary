# 人类在环智能体源码展示：企业报销工作流举例（附源码下载） - 铁蕾的个人博客
- URL: https://zhangtielei.com/posts/blog-coding-example-human-in-the-loop.html
- Added At: 2025-11-05 13:39:27
- Tags: #read #llm #deepdive
- [Link To Text](2025-11-05-人类在环智能体源码展示：企业报销工作流举例（附源码下载）---铁蕾的个人博客_raw.md)

## TL;DR
文章介绍如何利用Bridgic开源框架，在企业报销流程中实现“人类在环”机制。通过工作流设计、代码实现和执行恢复机制，展示如何中断工作流等待人工审批后再继续处理，无需长连接会话。

## Summary
本文通过企业报销工作流水示例，展示了在AI智能体开发中实现“人类在环（human-in-the-loop）”机制的源码实现，使用开源的Bridgic框架。文章重点聚焦于无需长连接和会话保持的第二种技术场景。

**主要实现流程：**
- **工作流设计**：报销工作流包括三个核心步骤：加载报销记录、自动审计、执行打款。打款前置入人类审批环节，通过`interact_with_human`触发交互。
- **代码示例**：定义了`ReimbursementWorkflow`类，继承自`GraphAutoma`。使用装饰器标注步骤依赖关系，例如：
  - `load_record`：初始步骤，从数据库加载记录。
  - `audit_by_rules`：审计步骤，检查金额等规则。
  - `execute_payment`：调用`interact_with_human`暂停工作流，等待管理员反馈；若反馈为“yes”，则执行打款。
- **执行与恢复机制**：
  - 首次执行`arun`时，工作流因交互暂停，抛出`InteractionException`，保存快照和交互ID。
  - 管理员反馈后，从数据库加载快照反序列化工作流，传入反馈数据重新执行`arun`，从断点处继续运行。

**原理解析**：
- Bridgic框架自动处理工作流暂停、序列化/反序列化。`interact_with_human`调用时，若无反馈则标记交互并抛异常；框架收集异常并生成快照。重新执行时，框架匹配反馈数据以恢复状态。

**其他讨论**：
- 可结合LLM增强功能，例如在审批前总结审计信息，或分析自然语言反馈。
- 自定义对象序列化需精细控制，框架支持选择性序列化必要数据。

**源码资源**：
- 报销示例代码、长连接方案示例及框架核心方法链接均提供，便于读者下载和实践。
