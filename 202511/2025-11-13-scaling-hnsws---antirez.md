# Scaling HNSWs - <antirez>
- URL: https://antirez.com/news/156
- Added At: 2025-11-13 14:26:17
- Tags: #read #deepdive

## TL;DR
Redis 创始人 antirez 总结了在 Redis 中实现 HNSW 的经验，基于低延迟需求介绍了内存优化（如 8 位量化）、并发操作支持、删除节点处理、多进程扩展、快速加载、JSON 过滤等优化措施。通过优化，Redis 的 HNSW 实现了高吞吐和良好伸缩性，适用于大规模向量检索场景。

## Summary
本文是作者 antirez 在 Redis 中实现并优化 HNSW（Hierarchical Navigable Small World）数据结构的经验总结。文章重点围绕如何使 HNSW 适应 Redis 低延迟、高性能的特性，从内存优化、速度提升、并发处理、删除操作、多进程扩展、加载时间优化及用例扩展等方面展开。

### 关键经验与优化措施

1. **内存优化**
   - **问题**：HNSW 和向量本身占用大量内存，原因包括大量指针、多层结构和浮点向量数据。
   - **量化策略**：
     - 默认采用 8 位量化（每个向量组件用 8 位整数表示），将向量大小减少约 4 倍，且召回率几乎不变。
     - 支持全精度向量和二进制量化选项，后者适用于原始数据已是二进制的场景。
   - **指针压缩**：考虑压缩指针的高位字节以节省空间，但需权衡时间开销。

2. **速度优化与并发**
   - **多线程支持**：HNSW 读操作多且慢，因此实现全线程化。读操作可并行执行；写操作分为读取阶段和提交阶段，仅提交阶段需写锁。
   - **节点访问标记**：使用“epoch”数组标记已访问节点，避免重复遍历，支持并发搜索。
   - **性能数据**：优化后可达 5 万操作/秒（现实负载），单线程库性能更高。

3. **删除操作与内存回收**
   - **问题**：许多 HNSW 实现无法直接删除节点，常采用标记删除导致内存泄漏。
   - **解决方案**：强制链接双向性（A 连 B 则 B 连 A），删除节点时通过启发式方法调整邻居链接，保持小世界属性。
   - **重连策略**：删除节点后，计算剩余节点间的距离矩阵，贪心配对以维持图形连接性，即使删除 95% 节点仍能保持良好召回率。

4. **多进程扩展**
   - **数据结构暴露**：将 HNSW 作为原生 Redis 数据结构（Vector Sets）暴露，支持直接操作（如 VADD、VREM、VSIM）。
   - **分布式扩展**：通过分片（如哈希取模）将数据分散到多个 Redis 实例，并行处理查询和写入，支持大规模向量集。
   - **灵活性**：支持为每个用户或项目创建独立的 Vector Sets，并可设置过期时间，简化用例建模。

5. **加载时间优化**
   - **序列化优化**：直接序列化节点和邻居指针，加载时快速重建 HNSW，提升速度 100 倍。
   - **安全性**：加强 RDB 文件加载的验证，使用哈希累加器检查链接互反性，确保数据完整性。

6. **用例扩展：JSON 过滤**
   - **功能**：支持在贪婪搜索过程中过滤 JSON 元数据（如年份范围），提升查询效率。
   - **实现**：节点可附加 JSON 属性，搜索时结合向量相似性和过滤条件，减少不必要的遍历。

7. **内存使用评估**
   - **实际数据**：300 万 Word2Vec 条目经 8 位量化后占用 3GB 内存（每条目约 1KB），性能达 4.8 万操作/秒。
   - **结论**：内存开销在多数用例中可接受，热数据应驻留内存，冷数据可存磁盘。

### 总结与展望
- HNSW 是强大且灵活的数据结构，适合向量相似性搜索，尤其在 AI 和嵌入学习场景下潜力巨大。
- 作者强调 HNSW 仍有改进空间（如层级必要性、删除操作），鼓励进一步研究。
- Redis Vector Sets 通过底层优化和直接数据结构暴露，为程序员提供高性能、可组合的解决方案。

代码和文档参考提供在 GitHub 链接中。
