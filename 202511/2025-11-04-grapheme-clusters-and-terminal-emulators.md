# Grapheme Clusters and Terminal Emulators
- URL: https://mitchellh.com/writing/grapheme-clusters-in-terminals
- Added At: 2025-11-04 15:18:51
- Tags: #read

## TL;DR
终端模拟器在处理Unicode字符如表情符号时，宽度计算常出现光标移动错误。问题源于传统方案依赖单字符宽度函数，无法正确处理多码位组合。解决方案是采用字形簇技术和Mode 2027协议，确保跨终端的兼容性和对全球语言支持。建议程序优先启用新模式，并动态计算文本宽度。

## Summary
本文探讨了终端模拟器在显示 Unicode 字符（特别是多码位组成的字形簇）时的光标移动不一致问题，并提出了解决方案。

### 核心问题
- 终端模拟器传统上基于固定大小的单元格网格运行，使用 `wcwidth` 函数确定字符宽度（例如，常规字符占1格，宽字符如亚洲文字或表情符号占2格）。
- 但现代 Unicode 字符（如表情符号 "🧑‍🌾"）可能由多个码位组成（如零宽度连接符 ZWJ 连接多个码点），`wcwidth` 会将其视为独立字符处理，导致光标移动错误（如移动4格而非预期的2格）。

### 字形簇处理
- 字形簇（grapheme cluster）是将多个码点组合成用户感知的单个字符的过程，遵循 Unicode 标准（UAX #29）。
- 终端需通过字形簇算法正确计算字符宽度，但实现复杂，需维护状态信息。
- 字形簇处理仅解决字符边界问题，渲染还需字体整形（如 Harfbuzz），否则字符可能显示异常。

### 终端现状与挑战
- 多数终端不支持字形簇，仍依赖 `wcwidth`，导致光标位置不一致（测试显示不同终端对 "🧑‍🌾" 的宽度报告为2、4、5或6格）。
- 终端程序（如 shell、编辑器）与终端模拟器的不匹配会引发光标同步问题，尤其在终端复用器（如 tmux）中更明显。

### 解决方案：Mode 2027
- Mode 2027 是一项提案，允许程序通知终端启用字形簇支持，通过控制序列查询和切换模式。
- 支持该模式的终端（如 Ghostty、Contour）可正确报告字符宽度，改善兼容性。

### 建议
- 终端程序作者：
  - 若不涉及光标定位，可忽略此问题。
  - 优先查询并启用 Mode 2027。
  - 通过查询光标位置（`CSI 6 n`）动态计算文本宽度，避免假设 `wcwidth` 或字形簇行为。
- 呼吁更多终端和程序支持 Mode 2027，以正确处理全球语言（如阿拉伯语）和特殊字符。

本文强调，字形簇支持不仅是表情符号显示问题，更关乎文本处理的准确性和国际化兼容性。
