# A new SQL-powered permissions system in Datasette 1.0a20
- URL: https://simonwillison.net/2025/Nov/4/datasette-10a20/
- Added At: 2025-11-05 13:20:00
- Tags: #read #llm #tips
- [Link To Text](2025-11-05-a-new-sql-powered-permissions-system-in-datasette-1.0a20_raw.md)

## TL;DR
Datasette 1.0a20 重构了权限系统，将权限检查从逐条函数调用改为基于SQLite查询，提升效率。新系统支持层次化权限、插件扩展和资源批量过滤，并增加调试工具。版本变更较大，提供升级指南与AI辅助开发工具，目标在社区升级插件后发布1.0正式版。

## Summary
### Datasette 1.0a20 新权限系统概述  
**发布信息**  
- 版本：Datasette 1.0a20（发布于2025年11月4日）。  
- 核心变化：权限系统重构，将权限逻辑迁移至 SQLite 中运行的 SQL 查询，是 1.0 版本前最大的破坏性 API 变更。  
- 开发规模：涉及 163 次提交、10,660 行新增代码和 1,825 行删除代码，主要借助 Claude Code 完成。

### 权限系统核心设计  
**目的**  
回答核心问题：“特定**执行者**（actor）是否被允许对特定**资源**（resource）执行特定**操作**（action）？”  
- **执行者**：用户或通过 API 操作的自动化程序。  
- **操作**：如查看表、执行 SQL、插入行等。  
- **资源**：操作的对象，如数据库、表。  
- 默认配置：公开只读，需插件支持写入等高级操作。

**改进动机**  
- 旧系统缺陷：每次权限检查需调用函数，效率低（如列出千个表时需千次检查）。  
- 新方案优势：利用 SQLite 高效过滤能力，通过 SQL 查询批量处理权限规则。

### 新权限机制：`permission_resources_sql()` 插件钩子  
- **取代旧钩子**：废弃 `permission_allowed()`，改为返回 SQL 查询的 `permission_resources_sql()`。  
- **返回结构**：  
  - 包含 `parent`（父资源，如数据库）、`child`（子资源，如表）、`allow`（1/0 表示允许/拒绝）、`reason`（调试原因）四列。  
  - 示例：仅允许用户 "alice" 查看 "accounting/sales" 表。  
- **工作流程**：合并所有插件的 SQL 查询，高效列出可访问资源，支持分页限制。

### 权限系统高级特性  
1. **层次结构**：权限可应用于全局、数据库级或表级。  
2. **插件扩展**：支持插件注册新操作（现内置 10 个操作）。  
3. **否决机制**：数据库级拒绝可被表级允许覆盖。  
4. **限制功能**：API 令牌可限制执行者仅访问部分资源。

### 新增调试工具  
- **资源列表页**：展示当前用户对特定操作的可访问资源（含路径、原因等）。  
- **规则列表页**：显示各插件返回的权限规则（如默认只读允许、root 用户全权限）。  
- **目的**：提升权限配置的透明度和可调试性。

### 局限性：无法列出所有有权执行者  
- **原因**：  
  - 系统无法预知所有执行者（如 SSO 插件动态认证用户）。  
  - API 令牌的临时性无法提前追踪。  
- **类比**：类似 AWS S3 无法列出所有可访问存储桶的账户。

### 插件升级与开发支持  
- **升级指南**：提供详细文档，指导插件适配新权限系统。  
- **自动化工具**：  
  - `tadd`：在开发版 Datasette 上运行插件测试。  
  - `radd`：在开发版运行带插件的 Datasette。  
- **AI 辅助**：使用 Claude Code 和 Codex CLI 自动化升级，依赖插件测试套件验证改动。

### 开发经验与 AI 协作  
- **AI 作用**：  
  - 突破代码库规模限制，能高效搜索、修改现有代码。  
  - 生成高质量代码、测试和提交消息，提升开发效率。  
  - 通过 GitHub PR 界面快速迭代修改。  
- **关键实践**：  
  - 重视测试（1.0a20 测试数增至 1,583）。  
  - 用 Markdown 指令文件（类似 Claude Skills）标准化升级流程。  
  - 实验成本降低，鼓励代码优化（如提取函数、文档补充）。

### 后续计划  
- **短期重点**：升级现有插件生态系统，支持社区适配。  
- **集成应用**：将新权限系统用于 Datasette Cloud，实现团队细粒度权限控制。  
- **版本目标**：此为 1.0 版前最大变更，力争在年底前发布正式版。
