# Code execution with MCP: building more efficient AI agents
- URL: https://www.anthropic.com/engineering/code-execution-with-mcp
- Added At: 2025-11-05 13:22:48
- Tags: #read #llm
- [Link To Text](2025-11-05-code-execution-with-mcp-building-more-efficient-ai-agents_raw.md)

## TL;DR
通过代码执行优化AI代理效率，将MCP工具转为代码API，使代理按需加载工具、本地处理数据。该方法大幅减少令牌消耗（如从15万降至2千），提升响应速度并增强隐私保护，但需平衡安全沙箱等实施成本。

## Summary
本文介绍了如何通过代码执行提升基于模型上下文协议（MCP）的AI代理的效率。MCP是一个开放标准，用于连接AI代理与外部系统。随着代理连接的工具数量增加，传统方式面临两个主要效率问题：工具定义会占用大量上下文窗口空间，增加延迟和成本；中间工具结果反复通过模型，导致令牌消耗激增。

代码执行通过将MCP工具呈现为代码API来解决这些问题。代理可以按需加载工具定义，并在执行环境中处理数据，无需将所有中间结果传递给模型。具体实现中，工具被组织成文件树结构，代理通过文件系统探索和调用所需工具。例如，处理Google Drive文档和Salesforce记录更新时，代理只需编写少量代码，令牌使用量可从15万降至2千，节省98.7%。

代码执行的优势包括：
1. **渐进式披露**：代理按需加载工具定义，避免一次性加载所有工具。
2. **上下文高效**：在执行环境中过滤、聚合数据，仅返回关键结果给模型。
3. **控制流优化**：使用循环、条件判断等代码结构简化复杂操作，减少交互次数。
4. **隐私保护**：敏感数据在执行环境中被标记化，避免泄露给模型。
5. **状态持久化**：代理可将中间结果保存为文件或可重用技能，提升长期任务效率。

但代码执行也引入了安全沙箱、资源监控等复杂性，需权衡其收益与实施成本。总之，代码执行借鉴了软件工程的成熟模式，帮助代理更高效地利用MCP协议，降低令牌消耗和延迟，推动可扩展AI系统的发展。
