# Immutable by Design: The Deep Tech Behind Tigris Bucket Forking | Tigris Object Storage
- URL: https://www.tigrisdata.com/blog/bucket-forking-deep-dive/
- Added At: 2025-11-05 13:51:59
- Tags: #read #deepdive

## TL;DR
Tigris对象存储的核心技术“存储桶分叉”基于数据不可变性设计，利用快照、写入前日志和有序键结构实现高效时间旅行和数据隔离。该技术支持TB级数据瞬间分叉，提供高安全性和性能，适用于AI实验等场景，未来将扩展功能以突破现有限制。

## Summary
本文深入探讨了Tigris对象存储的核心技术“存储桶分叉”（Bucket Forking），重点解释了其基于不变性设计的实现原理和优势。以下为结构化总结：

### 核心技术原理
1. **快照作为时间旅行机制**：
   - 快照通过一个64位整数（表示自1970年以来的纳秒数）记录存储桶在特定时间点的状态，允许数据恢复到任意历史时刻。
   - 实现方式是将时间戳反向排序（最大值减去当前纳秒数），确保最新版本始终优先被访问，同时保留所有历史版本。

2. **写入前日志（Write-Ahead Log）模型**：
   - 每个对象被设计为一个写入前日志，所有修改（创建、更新、删除）以追加方式记录，形成不可变版本链。
   - 类似Git和ZFS的机制，通过日志回放实现状态重建，确保数据可追溯和恢复。

3. **FoundationDB的有序性利用**：
   - Tigris利用FoundationDB键值存储的固有排序特性，将对象键结构设计为`bucket-name/object-name/version-id-timestamp`，通过反向时间戳实现高效查询。

### 存储桶分叉的实现
- **分叉机制**：基于快照创建新存储桶，形成独立的时间线分支。子存储桶继承父存储桶的快照状态，后续修改仅影响子桶，实现数据隔离。
- **递归查找**：读取对象时，系统优先检查子桶，若无结果则递归查询父桶快照，直至找到数据或返回“未找到”。这使分叉操作在毫秒级完成，无需复制数据。
- **删除保护**：删除操作在子桶中仅留下“墓碑标记”，不影响父桶数据，确保源数据永不丢失。

### 优势与应用场景
- **即时分叉**：支持TB级数据瞬间分叉，适用于AI代理、实验性工作流等场景，避免源数据被意外修改。
- **数据安全**：通过分叉提供数据删除保护，即使子桶数据被清空，源快照仍可恢复。
- **性能保障**：保持高持久性（99.999999999%）、可用性（99.99%）和快速分叉能力。

### 当前限制与未来展望
- **限制**：现有存储桶无法启用快照功能；快照存储桶仅支持标准存储层；暂不支持生命周期转换或自动删除功能；时间戳设计有效期限约至2550年。
- **未来**：计划扩展至128位时间戳等格式，并鼓励用户反馈以指导功能迭代。

总结：Tigris通过不可变设计和快照分叉技术，重新定义了对象存储的数据安全与灵活性，为核心数据提供了企业级保护。
