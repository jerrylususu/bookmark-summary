# Scaling Our Rate Limits to Prepare for a Billion Active Certificates
- URL: https://letsencrypt.org/2025/01/30/scaling-rate-limits/
- Added At: 2025-04-12 12:12:10

## TL;DR


Let’s Encrypt为应对TLS证书需求激增（覆盖5.5亿网站，年增42%），升级原MariaDB速率限制系统。采用Redis与GCRA算法，以高效存储和动态配额控制解决性能瓶颈，数据库操作减少80%，用户等待时间从数天缩短至小时级。新系统支持扩展，未来计划推广至更多API端点，优化配额规则，保障Web安全持续扩展。

## Summary


Let’s Encrypt为应对全球网站TLS证书需求的快速增长（现覆盖超过5.5亿网站，年增42%），升级了其速率限制系统，以解决原MariaDB架构的性能瓶颈。原系统在高并发下引发数据库压力激增、用户重置等待时间过长等问题。新系统基于Redis与GCRA算法，实现高效可扩展的速率管理。

### 原系统问题与挑战
1. **性能限制**  
   - MariaDB架构因频繁查询操作（尤其是rate limit计数）导致数据库读写压力激增，读操作量远高于其他表，峰值时成为核心瓶颈。
   - 使用滑动窗口机制导致用户因短时高频请求触发数日级惩罚性等待（如旧一周窗口期设计）。

2. **僵化机制与扩展性**  
   - 过多数据库表索引及分区难题导致清理操作复杂，尤其无法处理依赖unique key的特定表。
   - 存储与计算开销随业务增长持续攀升，威胁数据库稳定性。

### 新解决方案核心
1. **Redis存储方案**  
   - 采用Redis替代部分数据库功能，利用其高速读写能力和内存存储特性，自动过期（TTL）减少冗余数据维护。
   - 支持原子操作与批量处理，如TAT（理论到达时间）的高效更新与查询。

2. **GCRA算法（通用细胞速率算法）**  
   - 通过动态速率控制替代固定窗口，以TAT计算实时请求合法性，允许用户逐步恢复配额（如每秒1次请求，三击缓存）。
   - 简化存储需求（仅需单时间戳），降低计算复杂度，用户可获精准的Retry-After重试提示。

### 实施效果
1. **性能提升**  
   - 数据库操作减少80%，InnoDB行操作与缓存压力分别下降99%及50%以上，核心表读取量下降超过99%。
   - 新系统的速率检查延迟显著降低，高峰时段“新订单”端口响应时间优化明显。

2. **用户体验优化**  
   - 用户触发速率限制后的等待时间从数天缩短至小时级（如补丁方案后平均1.4天），GCRA实现渐进式速率恢复。
   - 新增僵尸客户端追踪机制，识别并拦截近半无效证书请求，释放基础设施资源。

3. **扩展潜力验证**  
   - Redis支持快速扩展，部署后唯一TAT计数器从1,260万增至3,000万+，系统仍保持稳定性能。

### 未来计划
1. **端点扩展**  
   - 将Redis-GCRA架构推广至其他API端点（如ACME），替代当前基于负载均衡的IP限速，提供更细粒度控制与用户反馈。

2. **策略重构**  
   - 探索脱离时间窗口的新速率限制模型，利用新系统动态能力制定更灵活的配额规则，同时平衡公平性与扩展性。

通过此次升级，Let’s Encrypt在提升系统稳定性的同时，实现了更公平、可预测的用户服务体验，为其持续支持Web安全扩展奠定基础。
