# Accurate Benchmarking
- URL: https://ates.dev/posts/2025-01-12-accurate-benchmarking/
- Added At: 2025-04-24 14:13:15

## TL;DR


文章提出消除循环开销以更精确测量代码执行时间的方法。传统方法将循环开销与目标函数执行时间共同计入总时间，导致快函数的测量误差失真。改进方案通过多次循环对比（分别执行n3次和2n3次函数），利用差值排除循环开销，实验显示其能消除约2%的误差。作者指出在多数场景下，传统方法误差可控，仍适合定性分析，而改进方法更适合需要精准定量比较的场景。

## Summary


文章讨论了如何通过数学方法消除循环开销以准确衡量代码执行时间。在直接运行代码难以测量时间差异时，需多次循环执行并计时总耗时（如函数`benchmarkTotal`）。但若要进行精确的定量分析（如百分比差异），需进一步考虑循环本身带来的开销。传统方法中，循环开销会被计入总时间，导致快方法的对比结果因开销占比而失真。

作者提出改进方法：将总迭代次数分为三部分，在两次循环中分别运行被测函数`n3`次和`2n3`次（即第二次循环每次调用两次函数），通过时间差值消除循环开销。假设单次循环总时间为`tp + ep`（方法运行时间+循环开销），则双次循环时间为`2tp + ep`，两者时间差即为`tp`。最终单次调用时间计算为`(delta) / n3`，即`(2tp) / n3`（实际推导中的计算需注意总次数为确保`n3 * 3 = iterations`）。实验显示，简单方法测得总时间包含约2%的循环开销，而改进方法能更准确估算单次执行时间。不过，作者认为2%的误差在多数场景中影响较小，定性比较仍足够使用。
