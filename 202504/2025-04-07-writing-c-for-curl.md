# Writing C for curl
- URL: https://daniel.haxx.se/blog/2025/04/07/writing-c-for-curl/
- Added At: 2025-04-07 14:13:14
- [Link To Text](2025-04-07-writing-c-for-curl_raw.md)

## TL;DR


curl项目通过严格测试（近五年仅2个高危漏洞）、零警告编译、禁用危险函数及禁用深嵌套代码等策略保障C语言代码安全。采用C89标准确保跨平台兼容，通过统一内存管理、自定义解析函数和输入长度限制（最大8MB）控制风险。代码坚持80列简短风格，结合工具自动化检查规范。主分支保持稳定，API严格命名，社区协作通过工具审核确保贡献代码安全，兼顾高性能与安全性。

## Summary


本文讨论了在curl项目中如何安全编写C语言代码的经验与策略。关键要点如下：

1. **代码安全与测试**  
   - 通过大量测试、静态分析工具和持续模糊测试保障代码质量。  
   - 近五年未发现重大漏洞，仅2个高危漏洞，其余为低中危。  
   - 目前C89代码约18万行，坚持原生C89以确保跨平台兼容性及避免重写。

2. **可读性与风格规范**  
   - 强调代码简洁易读，使用短函数和统一编码风格，工具自动检查代码规范。  
   - 限制代码行长为80列，采用双空格缩进，过深嵌套需拆分函数。  
   - 变量名和标识符保持简短，优先保障可读性。

3. **编译与代码质量**  
   - 零警告编译，使用严格编译选项，所有警告必须处理。  
   - 禁用危险函数（如`gets`、`sprintf`），工具自动拦截违规代码。

4. **内存管理与优化**  
   - 统一动态缓冲区处理，设置最大尺寸限制，减少`realloc`使用。  
   - 倡导使用`strdup`等合并分配与复制的操作，监控内存函数密度下降趋势。  
   - 避免冗余内存分配，确保高性能场景（如大文件下载）的高效性。

5. **数据处理与风险控制**  
   - 自定义解析函数替代`sscanf`，避免溢出和多余数据复制。  
   - 严格检查整数运算溢出，强制支持64位系统以减少溢出风险。  
   - 限制输入字符串长度（当前最大8MB），拦截异常输入。

6. **项目维护规范**  
   - 主分支代码始终保持稳定状态，仅合并经过充分验证的代码。  
   - 所有操作必须检查错误并释放资源，避免内存泄漏。  
   - 公开API前缀统一为`curl_`，确保兼容性。

7. **社区与协作**  
   - 通过自动工具和人工审核降低贡献代码风险，鼓励开发者参与，强调流程保障质量。
