# The Best Way to Use Text Embeddings Portably is With Parquet and Polars
- URL: https://minimaxir.com/2025/02/embeddings-parquet/
- Added At: 2025-02-25 13:50:39

## TL;DR
文章介绍了文本嵌入技术及其应用，重点讨论了如何在生成嵌入后高效存储和计算相似性。通过Magic卡牌嵌入示例，展示了使用numpy和Polars处理嵌入数据的快速方法。文章还探讨了不同存储方式的优缺点，推荐使用Parquet文件和Polars结合，提供了一种高效、易于使用的解决方案。

## Summary
1. **文本嵌入简介**：
   - 文本嵌入是由大型语言模型生成的一种现代嵌入技术，用于表示单词、句子、段落和文档。
   - 通过这些嵌入，可以计算对象之间的数学相似性。

2. **应用示例：Magic卡牌嵌入**：
   - 作者生成了32,254张Magic卡牌的嵌入，基于卡牌设计、名称、费用、文本和稀有度等属性。
   - 通过嵌入可以找到卡牌之间的相似性，并生成有趣的2D UMAP投影。

3. **嵌入生成与存储问题**：
   - 大多数教程忽略了一个重要问题：生成嵌入后如何处理它们？
   - 常见的解决方案是使用向量数据库，但这些工具配置复杂、成本高且难以移植。

4. **使用numpy进行相似性计算**：
   - 使用numpy可以直接在内存中计算嵌入之间的相似性，速度快且占用内存少。
   - 示例代码展示了如何快速计算查询向量与嵌入矩阵的点积，得出相似性分数。

5. **保存嵌入的错误方式**：
   - **CSV文件**：文本格式存储嵌入会导致文件过大，加载速度慢，尽管OpenAI的教程中使用了这种方法。
   - **Numpy的`.txt`文件**：虽然简单，但文件过大且加载速度慢。
   - **Pickle文件**：虽然快速加载，但存在安全风险和兼容性问题。

6. **保存嵌入的较好方式**：
   - **Numpy的`.npy`文件**：比Pickle更安全，但仍存在元数据与嵌入映射的问题。
   - **元数据映射问题**：直接在numpy中处理元数据会导致技术债务增加，难以维护。

7. **Parquet文件的优势**：
   - Parquet是一种列式存储格式，支持嵌套数据类型，适合存储嵌入及其元数据。
   - Parquet文件加载速度快，支持高效的压缩和解压缩。

8. **使用Parquet和Polars处理嵌入**：
   - **Parquet与Pandas**：Pandas支持Parquet文件的读写，但处理嵌套数据能力有限。
   - **Polars的优势**：Polars是一个高性能的DataFrame库，支持嵌套数据，与numpy无缝集成，适合处理嵌入数据。
   - **Polars示例**：通过Polars读取Parquet文件，直接提取嵌入矩阵并进行相似性计算，支持动态过滤和快速查询。

9. **性能测试**：
   - 使用Polars进行嵌入相似性计算的平均时间为1.48ms，虽然比直接使用numpy稍慢，但性能仍然足够快。

10. **扩展与商业应用**：
    - 对于小规模项目，Parquet和Polars的组合已经足够。
    - 对于大规模商业应用，向量数据库可能是更好的选择，但需要权衡成本与收益。

11. **其他选择**：
    - 对于无法完全装入内存的数据，可以考虑使用支持嵌入的SQLite扩展，如`sqlite-vec`。

12. **总结**：
    - 对于许多应用，结合Parquet文件和Polars提供了一个高效、快速且易于使用的解决方案，无需依赖复杂的向量数据库。
