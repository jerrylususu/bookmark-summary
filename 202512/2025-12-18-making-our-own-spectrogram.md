# Making our own spectrogram
- URL: https://fasterthanli.me/articles/making-our-own-spectrogram#the-gabor-limit
- Added At: 2025-12-18 16:10:01
- Tags: #read #rust #deepdive
- [Link To Text](2025-12-18-making-our-own-spectrogram_raw.md)

## TL;DR
这篇文章介绍了用Rust开发音频频谱图可视化工具的全过程，包括傅里叶变换理论、分块加窗处理、多线程架构设计，以及性能优化方案。文章通过实际代码和多种音乐频谱演示，实现了实时音频分析，并讨论了工程实践中的关键权衡。

## Summary
这篇文章详细介绍了如何使用Rust语言开发一个音频频谱图（spectrogram）可视化工具。内容涵盖了从基础理论到实际实现的多个方面，主要包括：

### 理论基础
- **傅里叶变换**：核心原理是将时域信号转换为频域信号，通过正弦波和余弦波的叠加来重构复杂波形（如方波）。
- **声音参数**：包括振幅（控制音量）、频率（控制音高）、直流偏移（影响波形裁剪）和相位（影响多波混合时的干涉）。
- **实际应用**：傅里叶变换不仅适用于合成信号，也能分析真实音频（如人声录音）。

### 技术实现关键点
- **分块与加窗**：
  - 使用FFT（快速傅里叶变换）处理音频，需将长音频分块（如1024样本/块）。
  - 汉宁窗（Hann window）用于减少分块边界处的频谱泄漏，通过重叠添加（overlap-add）确保重构平滑。
- **Gabor极限**：时间分辨率与频率分辨率之间的权衡。作者选择4096样本窗口和97%重叠，以平衡清晰度。
- **插值与颜色映射**：
  - 频域插值（线性插值）使频谱图更平滑。
  - 使用感知均匀的颜色映射（如colorcet库的"fire"梯度）提升可读性。
- **频率映射**：采用分段对数缩放，优化人类听觉敏感的低频区域显示，避免高频占用过多空间。

### 系统架构
- **音频输入**：通过cpal库捕获系统音频（如虚拟设备输入），支持多样本格式（如f32、i16）。
- **多线程处理**：
  - 音频线程：实时接收样本，通过通道发送给处理线程。
  - 处理线程：应用汉宁窗，执行FFT，计算幅度和功率，转换为分贝值。
  - UI线程（使用egui/eframe）：从共享队列获取数据，更新纹理并绘制频谱图。
- **数据流**：音频样本→通道→处理线程→共享队列→UI线程，确保实时性。

### 性能与优化
- **性能问题**：CPU使用率高，主要开销在纹理克隆（占25%）和GPU上传（占40%）。
- **剖析工具**：使用Apple Instruments分析，发现FFT计算占处理线程27%时间，音频样本克隆和通道通信也有显著开销。
- **改进空间**：可优化纹理更新（如部分更新）、限制队列大小防止内存溢出。

### 实际应用与乐趣
- 作者演示了多种音乐风格（如电子音乐、芯片音乐、流行歌曲）的频谱图，突出频率变化和制作特点。
- 工具虽未极致优化，但实现了实时可视化目标，便于观察音频特征（如颤音、频率扫掠）。

整体上，文章结合理论解释、代码示例和性能分析，完整展示了从零构建频谱图工具的过程，强调了工程实践中的设计权衡。
