Title: TCP Fast Open

URL Source: https://dbwu.tech/posts/network/what-is-tcp-fast-open/

Published Time: 2019-01-05T00:00:00+00:00

Markdown Content:
2019-01-05 [è®¡ç®—æœºç½‘ç»œ](https://dbwu.tech/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C)

*   [æ¦‚è¿°](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E6%A6%82%E8%BF%B0)
*   [TFO](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#tfo)
    *   [å®ç°åŸç†ï¼š](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86)
        *   [1\. é¦–æ¬¡è¿æ¥](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#1-%E9%A6%96%E6%AC%A1%E8%BF%9E%E6%8E%A5)
        *   [2\. åç»­è¿æ¥](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#2-%E5%90%8E%E7%BB%AD%E8%BF%9E%E6%8E%A5)
    *   [ä¼˜ç‚¹](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E4%BC%98%E7%82%B9)
    *   [å±€é™æ€§](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E5%B1%80%E9%99%90%E6%80%A7)
*   [æ¨¡æ‹Ÿç¯å¢ƒ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E6%A8%A1%E6%8B%9F%E7%8E%AF%E5%A2%83)
    *   [å†…æ ¸å‚æ•°è°ƒæ•´](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4)
*   [ç¨‹åºä»£ç ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E7%A8%8B%E5%BA%8F%E4%BB%A3%E7%A0%81)
    *   [æ¥æ”¶æ–¹ (æœåŠ¡ç«¯) ä»£ç ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E6%8E%A5%E6%94%B6%E6%96%B9-%E6%9C%8D%E5%8A%A1%E7%AB%AF-%E4%BB%A3%E7%A0%81)
    *   [å‘é€æ–¹ (å®¢æˆ·ç«¯) ä»£ç ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E5%8F%91%E9%80%81%E6%96%B9-%E5%AE%A2%E6%88%B7%E7%AB%AF-%E4%BB%A3%E7%A0%81)
*   [è¿è¡Œç¨‹åºå®éªŒ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F%E5%AE%9E%E9%AA%8C)
    *   [1\. å¯åŠ¨æœåŠ¡ç«¯ç¨‹åºï¼Œå¹¶ç¡®è®¤ç›‘å¬çŠ¶æ€](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#1-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A8%8B%E5%BA%8F%E5%B9%B6%E7%A1%AE%E8%AE%A4%E7%9B%91%E5%90%AC%E7%8A%B6%E6%80%81)
    *   [2\. å®¢æˆ·ç«¯å¼€å§‹æŠ“åŒ…](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%80%E5%A7%8B%E6%8A%93%E5%8C%85)
    *   [3\. è¿è¡Œå®¢æˆ·ç«¯ç¨‹åº](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#3-%E8%BF%90%E8%A1%8C%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%A8%8B%E5%BA%8F)
    *   [4\. æŸ¥çœ‹å®¢æˆ·ç«¯ TCP è¿æ¥çŠ¶æ€](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#4-%E6%9F%A5%E7%9C%8B%E5%AE%A2%E6%88%B7%E7%AB%AF-tcp-%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81)
*   [WireShark æŠ“åŒ…ç»“æœåˆ†æ](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#wireshark-%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90)
    *   [ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5)
    *   [åç»­å»ºç«‹è¿æ¥](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#%E5%90%8E%E7%BB%AD%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5)
*   [Reference](https://dbwu.tech/posts/network/what-is-tcp-fast-open/#reference)

æ¦‚è¿°
--

åœ¨ä¹‹å‰çš„æ–‡ç«  [ä¸ºä»€ä¹ˆ TCP å»ºç«‹è¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹](https://dbwu.tech/posts/network/why-tcp-does-needs-three-way-handshake/#fqa) ä¸­ï¼Œå…³äºä¸‹é¢ 3 ä¸ªé—®é¢˜ç»™å‡ºäº†ç®€å•çš„å›ç­”:

1.  ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶å¯ä»¥æºå¸¦åº”ç”¨æ•°æ®å—ï¼Ÿ
2.  ç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶å¯ä»¥æºå¸¦åº”ç”¨æ•°æ®å—ï¼Ÿ
3.  ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶å¯ä»¥æºå¸¦åº”ç”¨æ•°æ®å—ï¼Ÿ

ç®€å•æ¥è¯´ï¼Œä¼ ç»Ÿçš„ TCP å»ºç«‹è¿æ¥æ—¶éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œä¸”è¿™ä¸‰æ¬¡æ¡æ‰‹åªæ˜¯å‘é€ç®€å•çš„ `SYN` å’Œ `ACK` æŠ¥æ–‡ã€‚

ä»ç½‘ç»œå¸¦å®½çš„èµ„æºåˆ©ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œä¼ è¾“å±‚çš„ TCP å¤´éƒ¨ + ç½‘ç»œå±‚çš„ IP å¤´éƒ¨ï¼Œæœ€å°‘æœ‰ 40 ä¸ªå­—èŠ‚ï¼Œä¸ºäº†å‘é€å‡ ä¸ªå­—èŠ‚çš„æŠ¥æ–‡æ•°æ®åŒ…ï¼Œè€Œé¢å¤–ç»„è£…äº† 40 ä¸ªå­—èŠ‚çš„å¤´éƒ¨ï¼Œè¿™æœ‰ç‚¹ç±»ä¼¼ [æ‰€è°“çš„ â€œç³Šæ¶‚çª—å£ç»¼åˆç—‡â€](https://dbwu.tech/posts/network/what-is-tcp-sliding-window/#%E7%B3%8A%E6%B6%82%E7%AA%97%E5%8F%A3%E7%BB%BC%E5%90%88%E7%97%87)ã€‚

ä»åº”ç”¨ä¼˜åŒ–çš„è§’åº¦æ¥çœ‹ï¼Œå› ä¸ºè¦ç­‰åˆ° TCP ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ä¹‹åæ‰èƒ½å‘é€åº”ç”¨å±‚æ•°æ®ï¼Œæ‰€ä»¥ä¼šé€ æˆåº”ç”¨ç¨‹åºé¦–æ¬¡å‘é€æ•°æ®æ—¶å­˜åœ¨ä¸€å®šçš„å»¶è¿Ÿï¼Œå°¤å…¶æ˜¯çŸ­è¿æ¥ã€ç§»åŠ¨è®¾å¤‡ç­‰åœºæ™¯ä¸­ï¼Œè¿™ç§å‰¯ä½œç”¨ä¼šåŠ å‰§ã€‚

é‚£ä¹ˆè¿™ç§é—®é¢˜å¦‚ä½•è§£å†³å‘¢ï¼Ÿä½¿ç”¨ `TFO` è§£å†³æ–¹æ¡ˆã€‚

ğŸ“ PS: å› ä¸º TCP åè®®æ ˆä¸åŒç‰ˆæœ¬é—´å­˜åœ¨å·®å¼‚ï¼Œæ‰€ä»¥**æœ¬æ–‡çš„å‰ææ˜¯ TCP ä¸‰æ¬¡æ¡æ‰‹æ—¶ä¸ä¼ è¾“æ•°æ® (ä¼ ç»Ÿçš„ä¸‰æ¬¡æ¡æ‰‹)**ï¼Œäº‹å®ä¸Šï¼Œå¾ˆå¤šäº‘è®¡ç®—æœåŠ¡å•†æä¾›çš„ Linux å‘è¡Œç‰ˆæœ¬éƒ½å¯¹ç½‘ç»œåè®®æ ˆè¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¼šåœ¨ TCP ç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶ç›´æ¥å‘é€æ•°æ®ï¼Œè¯»è€…è‡ªå·±æŠ“åŒ…éªŒè¯æ—¶ï¼Œå¯èƒ½ä¼šå’Œæœ¬æ–‡ç»“æœå­˜åœ¨ä¸€å®šå·®å¼‚ã€‚

* * *

TFO
---

**TCP Fast Open (TFO) æ˜¯åœ¨ä¼ ç»Ÿçš„ä¸‰æ¬¡æ¡æ‰‹åŸºç¡€ä¸Šè¿›è¡Œä¼˜åŒ–ï¼Œå…è®¸åœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­å‘é€æ•°æ®ï¼Œä»è€Œå‡å°‘é¦–æ¬¡å‘é€æ•°æ®çš„å»¶è¿Ÿï¼Œæå‡ç½‘ç»œåº”ç”¨æ€§èƒ½**ã€‚

### å®ç°åŸç†ï¼š

`TFO` çš„æ ¸å¿ƒåŸç†æ˜¯åœ¨å‘é€æ–¹å’Œæ¥æ”¶æ–¹é€šä¿¡ä¸­ï¼Œå¼•å…¥ 1 ä¸ª **Cookie** æœºåˆ¶ï¼Œè¿™æ ·ä½¿å‘é€æ–¹åœ¨åç»­é‡è¿æ¥æ”¶æ–¹æ—¶ï¼Œèƒ½å¤Ÿç®€åŒ– TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚

> é¡¾åæ€ä¹‰ï¼ŒTFO Cookie ä¸­çš„ Cookie å’Œ Web åº”ç”¨å±‚ ä¸­çš„ Cookie æœºåˆ¶ä¸€æ ·ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œéœ€è¦ç™»å½•éªŒè¯ï¼Œç„¶åç”±æœåŠ¡ç«¯éªŒè¯åï¼Œåç»­è®¿é—®ä¸­å¯ä»¥ç›´æ¥æºå¸¦ï¼Œæ— éœ€å†æ¬¡ç™»å½•ã€‚

#### 1\. é¦–æ¬¡è¿æ¥

*   å½“å‘é€æ–¹ç¬¬ä¸€æ¬¡å’Œæ¥æ”¶æ–¹å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œå‘é€ 1 ä¸ª `SYN` æŠ¥æ–‡
*   æ¥æ”¶æ–¹è¿”å› `SYN-ACK` æŠ¥æ–‡çš„åŒæ—¶ï¼Œé™„å¸¦ä¸€ä¸ªéšæœºç”Ÿæˆçš„åä¸º `TFO Cookie` çš„æ ‡è¯†ç¬¦ç»™å‘é€æ–¹
*   å‘é€æ–¹æ”¶åˆ° `SYN-ACK` æŠ¥æ–‡åï¼Œä¿å­˜ `TFO Cookie`ï¼Œå‘é€ `ACK` æŠ¥æ–‡ç»™æ¥æ”¶æ–¹ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œå¼€å§‹ä¼ è¾“æ•°æ®

![Image 1](https://dbwu.tech/images/network/tcp-fast-open/9.png)

#### 2\. åç»­è¿æ¥

*   å½“å‘é€æ–¹å†æ¬¡è¿æ¥åŒä¸€ä¸ªæ¥æ”¶æ–¹æ—¶ï¼Œå¯ä»¥åœ¨ `SYN` æŠ¥æ–‡ä¸­æºå¸¦ä¸Šæ¬¡ä¿å­˜çš„ `TFO Cookie`ï¼ŒåŒæ—¶åœ¨ `SYN` æŠ¥æ–‡ä¸­é™„å¸¦åº”ç”¨å±‚æ•°æ® (ä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶å°±ç›´æ¥å‘é€æ•°æ®)
*   æ¥æ”¶æ–¹éªŒè¯å‘é€æ–¹çš„ `TFO Cookie` åï¼Œå°†æ•°æ®å‘é€ç»™åº”ç”¨å±‚å¤„ç†ï¼Œå¹¶è¿”å› `SYN-ACK` æŠ¥æ–‡ (åŒæ—¶ä¹Ÿå¯ä»¥å‘é€æ•°æ®)
*   å‘é€æ–¹æ”¶åˆ° `SYN-ACK` æŠ¥æ–‡åï¼Œå‘é€ `ACK` æŠ¥æ–‡ç»™æ¥æ”¶æ–¹ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹

![Image 2](https://dbwu.tech/images/network/tcp-fast-open/10.png)

### ä¼˜ç‚¹

é€šè¿‡ `TFO`ï¼Œå‘é€æ–¹åœ¨å‘é€ `SYN` æŠ¥æ–‡æ—¶å°±å¯ä»¥ç›´æ¥æºå¸¦æ•°æ®ï¼Œæ¥æ”¶æ–¹å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶ç›´æ¥å¤„ç†æ•°æ®ï¼Œå¹¶ä¸”åœ¨ç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶ç›´æ¥å‘é€æ•°æ®ï¼Œæœ€ç»ˆ:

*   **å‘é€æ–¹ç¬¬ä¸€æ¬¡å‘é€æ•°æ®ï¼Œå‡å°‘äº† 1.5 ä¸ª RTT å»¶è¿Ÿ**
*   **æ¥æ”¶æ–¹ç¬¬ä¸€æ¬¡å‘é€æ•°æ®ï¼Œå‡å°‘äº† 1 ä¸ª RTT å»¶è¿Ÿ**

![Image 3: å‘é€æ–¹ç¬¬ä¸€æ¬¡å‘é€æ•°æ®ï¼Œå‡å°‘äº† 1.5 ä¸ª RTT å»¶è¿Ÿ](https://dbwu.tech/images/network/tcp-fast-open/12.png)

![Image 4: æ¥æ”¶æ–¹ç¬¬ä¸€æ¬¡å‘é€æ•°æ®ï¼Œå‡å°‘äº† 1 ä¸ª RTT å»¶è¿Ÿ](https://dbwu.tech/images/network/tcp-fast-open/11.png)

### å±€é™æ€§

1.  å…¼å®¹æ€§

éœ€è¦é€šä¿¡åŒæ–¹éƒ½æ”¯æŒ TFO, å¦‚æœå…¶ä¸­ä¸€æ–¹ä¸æ”¯æŒï¼Œè¿æ¥è‡ªåŠ¨å›é€€åˆ°ä¼ ç»Ÿçš„ TCP è¿æ¥å»ºç«‹è¿‡ç¨‹ï¼Œæ­¤å¤–ï¼Œé€šä¿¡é“¾è·¯ä¸­çš„è½¬å‘è®¾å¤‡ (NAT, é˜²ç«å¢™) ä¹Ÿä¼šæ‰§è¡Œè¿™ä¸ªå…¼å®¹æ€§æœºåˆ¶ã€‚

2.  å®‰å…¨æ€§

è™½ç„¶ `TFO` çš„ Cookie æ˜¯ç”±æ¥æ”¶æ–¹ç”Ÿæˆå¹¶å‘é€ç»™å‘é€æ–¹çš„ï¼Œå¹¶ä¸”æ¯ä¸ª Cookie éƒ½ä¸å‘é€æ–¹å…³è”ï¼Œä½†æ˜¯å¢åŠ äº†æ¥æ”¶æ–¹çš„å®‰å…¨æ”»å‡»é¢ï¼Œå¯èƒ½å¼•å‘è¯¸å¦‚ [â€œTCP SYN Floodâ€ æ”¾å¤§æ”»å‡»](https://dbwu.tech/posts/network/what-is-ddos/) ç­‰å®‰å…¨é£é™©ã€‚

å¦‚æœæ”»å‡»è€…ä»è¢«å…¥ä¾µä¸»æœºè·å–åˆ°æœ‰æ•ˆçš„ `TFO Cookie`ï¼Œè¿›è€Œä¼ªé€ äº†å¤§é‡çš„æºå¸¦æ•°æ®æŠ¥æ–‡ï¼Œé‚£ä¹ˆæ¥æ”¶æ–¹å°±éœ€è¦å¤§é‡çš„å†…å­˜æ¥ä¸´æ—¶å­˜å‚¨åº”ç”¨æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜è€—å°½ã€‚

3.  éƒ¨ç½²ç¯å¢ƒè¦æ±‚

å¯¹å†…æ ¸ç‰ˆæœ¬æœ‰è¦æ±‚ï¼Œä¸”éœ€è¦ä¿®æ”¹å†…æ ¸å‚æ•°ã€‚

4.  åº”ç”¨æ•°æ®è¿‡å¤§

å¦‚æœå‘é€æ–¹ç¬¬ä¸€æ¬¡è¦å‘é€çš„æ•°æ®å¤§äº [TCP çš„ MSS](https://dbwu.tech/posts/network/mtu-with-mss/), ä¾ç„¶éœ€è¦æ‹†åŒ…è¿›è¡Œå¤šæ¬¡å‘é€ï¼Œå½“åº”ç”¨æ•°æ®è¿‡å¤§æ—¶ï¼Œ`TCP Fast Open` å¸¦æ¥çš„ä¼˜åŠ¿ (RTT å‡å°‘) å‡ ä¹å¯ä»¥å¿½ç•¥ã€‚

* * *

æ¨¡æ‹Ÿç¯å¢ƒ
----

`TFO` éœ€è¦å‘é€æ–¹å’Œæ¥æ”¶æ–¹åŒæ—¶æ”¯æŒï¼Œå¦‚æœä»»æ„ä¸€æ–¹ä¸æ”¯æŒ TFOï¼Œè¿æ¥ä¼šè‡ªåŠ¨å›é€€åˆ°ä¼ ç»Ÿçš„ä¸‰æ¬¡æ¡æ‰‹æ–¹å¼ã€‚

ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œç¬”è€…ä½¿ç”¨äº† 2 ä¸ª Linux æœåŠ¡å™¨ä½œä¸ºé€šä¿¡å‘é€æ–¹å’Œæ¥æ”¶æ–¹ï¼Œå¯¹åº”çš„å‘è¡Œç‰ˆæœ¬å’Œå†…æ ¸ç‰ˆæœ¬å‚æ•°å¦‚ä¸‹ã€‚

> TFO å¯¹ Linux å†…æ ¸ç‰ˆæœ¬è¦æ±‚: \>\= 3.7ã€‚

```

# å‘é€æ–¹

## å‘è¡Œç‰ˆæœ¬ (WSL2 ç¯å¢ƒ)
$ cat /etc/os-release 

PRETTY_NAME="Debian GNU/Linux 11 (bullseye)"
NAME="Debian GNU/Linux"
VERSION_ID="11"
VERSION="11 (bullseye)"
VERSION_CODENAME=bullseye
ID=debian

## å†…æ ¸ç‰ˆæœ¬
$ uname -r

5.10.0-21-amd64

# æ¥æ”¶æ–¹

## å‘è¡Œç‰ˆæœ¬
$ cat /etc/os-release

NAME="CentOS Linux"
VERSION="7 (Core)"
ID="centos"
ID_LIKE="rhel fedora"
VERSION_ID="7"
PRETTY_NAME="CentOS Linux 7 (Core)"

## å†…æ ¸ç‰ˆæœ¬
$ uname -r

3.10.0-1160.53.1.el7.x86_64
```

### å†…æ ¸å‚æ•°è°ƒæ•´

`TFO` å¯ç”¨éœ€è¦ä¿®æ”¹é»˜è®¤å†…æ ¸å‚æ•°:

*   `0`ï¼šå…³é—­ TFO
*   `1`ï¼šå¯ç”¨å‘é€æ–¹æ¨¡å¼ TFO
*   `2`ï¼šå¯ç”¨æ¥æ”¶æ–¹æ¨¡å¼ TFO
*   `3`ï¼šåŒæ—¶å¯ç”¨å‘é€æ–¹å’Œæ¥æ”¶æ–¹æ¨¡å¼ TFO

```

# å‘é€æ–¹å¯ç”¨ TFO
$ echo 1 | sudo tee /proc/sys/net/ipv4/tcp_fastopen

# æ¥æ”¶æ–¹å¯ç”¨ TFO
# å†™å…¥ 3 è¡¨ç¤ºæ—¢å¯ç”¨å‘é€æ–¹ TFO ä¹Ÿå¯ç”¨æ¥æ”¶æ–¹ TFO
$ echo 3 | sudo tee /proc/sys/net/ipv4/tcp_fastopen
```

ä½œä¸ºæ¨¡æ‹Ÿå®éªŒï¼Œç¬”è€…åªæ˜¯ä¸´æ—¶ä¿®æ”¹äº†å‚æ•°ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ­¥éª¤è¿›è¡Œé…ç½®æ°¸ä¹…ç”Ÿæ•ˆ:

1.  ç¼–è¾‘ `/etc/sysctl.conf` æ–‡ä»¶ï¼Œæ·»åŠ é…ç½®é¡¹

2.  è¿è¡Œ `sysctl -p` å‘½ä»¤ç”Ÿæ•ˆï¼Œé‡å¯ä¹‹åä»ç„¶æœ‰æ•ˆ

* * *

ç¨‹åºä»£ç 
----

å¦‚æœè¯»è€…ä½¿ç”¨ä¸»æœºçš„ `curl` ç‰ˆæœ¬è¾ƒé«˜ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ç›´æ¥å¼€å¯ `TFO` æœºåˆ¶æ–¹å¼è®¿é—®:

```

$ curl --tcp-fastopen http://example.com

# å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ç¡®è®¤ curl ç‰ˆæœ¬æ˜¯å¦æ”¯æŒ TFO
$ curl -V | grep -i TFO
```

å› ä¸ºç¬”è€…æ‰€ä½¿ç”¨çš„æœåŠ¡å™¨ä¸­çš„ `curl` ç‰ˆæœ¬è¾ƒä½ï¼Œæ‰€ä»¥è¿™é‡Œç¼–å†™ `Python` è„šæœ¬ä»£ç ï¼Œæ ¸å¿ƒä»£ç å…¶å®å°±æ˜¯ 2 ä¸ªå¥—æ¥å­—çš„å‚æ•°çš„è®¾ç½®è€Œå·²ã€‚

### æ¥æ”¶æ–¹ (æœåŠ¡ç«¯) ä»£ç 

å°†æ¥æ”¶æ–¹ä½œä¸ºæœåŠ¡ç«¯ç¨‹åºçš„æ–¹å¼æ¥å®ç°ï¼Œç»‘å®š/ç›‘å¬æŒ‡å®šç«¯å£ï¼Œç„¶åæ¥æ”¶æ¥è‡ªå‘é€æ–¹ (å®¢æˆ·ç«¯) çš„ TCP è¿æ¥ã€‚

```

# service.py

import socket

def listen():
    # åˆå§‹åŒ–æœåŠ¡ç«¯ç›‘å¬å¯¹è±¡
    listener = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    # å‚æ•° 32 è¡¨ç¤º TCP åè®®æ ˆ
    # æœªå®Œæˆçš„ Fast Open é˜Ÿåˆ—é•¿åº¦
    listener.setsockopt(socket.SOL_TCP, socket.TCP_FASTOPEN, 32)

    # ç›‘å¬ 12345 ç«¯å£å·
    # ä¸ºäº†æ¨¡æ‹Ÿï¼Œæ‰€ä»¥ä¸ç”¨ä¸»æµç«¯å£å·äº† :-)
    listener.bind(('0.0.0.0', 12345))
    # æœ€å¤§è¿æ¥æ•°è®¾ç½®ä¸º 1024
    listener.listen(1024)

    print("Server is listening on port 12345...")

    # è½®è¯¢æ¥æ”¶æ–°çš„ TCP è¿æ¥
    while True:
        conn, addr = listener.accept()
        print(f"Accepted connection from {addr}")
        print(f"Received data: {conn.recv(1024)}")

        conn.send(b"Hello, Client")
        conn.close()

        print(f"Closed connection with {addr}")


if __name__ == "__main__":
    try:
        # å¯åŠ¨ç›‘å¬
        listen()
    except KeyboardInterrupt:
        # æ•è· Ctrl + C ç»ˆæ­¢ç¨‹åº
        print("Server shutting down...")
```

### å‘é€æ–¹ (å®¢æˆ·ç«¯) ä»£ç 

```

# client.py

import socket

# åˆå§‹åŒ–å®¢æˆ·ç«¯ç›‘å¬å¯¹è±¡
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# å‚æ•° 32 è¡¨ç¤º TCP åè®®æ ˆ
# æœªå®Œæˆçš„ Fast Open é˜Ÿåˆ—é•¿åº¦
sock.setsockopt(socket.SOL_TCP, socket.TCP_FASTOPEN, 32)

# å‘æœåŠ¡ç«¯å‘é€æ•°æ®æ—¶
# è®¾ç½® Fast Open é€‰é¡¹
sock.sendto(b"Hello, Server", socket.MSG_FASTOPEN, ("104.21.71.166", 12345))

print(f"Received data: {conn.recv(1024)}")

sock.close()
```

* * *

è¿è¡Œç¨‹åºå®éªŒ
------

ç¨‹åºæ ¸å¿ƒä»£ç  (æ€»å…± 2 è¡Œ) å‡†å¤‡å°±ç»ªï¼Œæ¥ä¸‹æ¥å¼€å§‹è¿è¡Œç¨‹åºï¼ŒéªŒè¯ `TCP Fast Open` è¿‡ç¨‹ã€‚

æœåŠ¡ç«¯å…¬ç½‘ IP: `104.21.71.166`

### 1\. å¯åŠ¨æœåŠ¡ç«¯ç¨‹åºï¼Œå¹¶ç¡®è®¤ç›‘å¬çŠ¶æ€

```

# åœ¨ 1 ä¸ªç»ˆç«¯å¯åŠ¨æœåŠ¡ç«¯ç¨‹åº

$ python3 server.py

# åœ¨å¦å¤– 1 ä¸ªç»ˆç«¯æŸ¥çœ‹ç¨‹åºç›‘å¬çŠ¶æ€æ˜¯å¦æ­£å¸¸

$ netstat -ant | grep 12345 | grep LISTEN

tcp        0      0 0.0.0.0:12345            0.0.0.0:*               LISTEN
```

### 2\. å®¢æˆ·ç«¯å¼€å§‹æŠ“åŒ…

æ‰“å¼€ WireShark, ç›‘å¬å¯¹åº”çš„ç½‘å¡è®¾å¤‡ã€‚

### 3\. è¿è¡Œå®¢æˆ·ç«¯ç¨‹åº

```

# ä¸ºäº†éªŒè¯æ•ˆæœï¼Œè¿™é‡Œå¯ä»¥è¿ç»­è¿è¡Œå‡ æ¬¡
# æ¯æ¬¡è¿è¡Œé—´éš” 3 - 5 ç§’å³å¯
$ python3 client.py

# è¾“å‡ºçœç•¥
...
```

### 4\. æŸ¥çœ‹å®¢æˆ·ç«¯ TCP è¿æ¥çŠ¶æ€

```

netstat -ant | grep 12345 | grep TIME_WAIT

# è¾“å‡ºå¦‚ä¸‹
# è¿ç»­è¿è¡Œäº†å¤šå°‘æ¬¡ client.py 
# å°±ä¼šäº§ç”Ÿå¤šå°‘ TIME_WAIT çŠ¶æ€çš„ TCP è¿æ¥
# 10.0.0.53 ä¸ºå®¢æˆ·ç«¯çš„å†…ç½‘ IP åœ°å€


tcp        0      0 10.0.0.53:38084         104.21.71.166:12345       TIME_WAIT  
tcp        0      0 10.0.0.53:37530         104.21.71.166:12345       TIME_WAIT  
tcp        0      0 10.0.0.53:37528         104.21.71.166:12345       TIME_WAIT  
tcp        0      0 10.0.0.53:38076         104.21.71.166:12345       TIME_WAIT  
tcp        0      0 10.0.0.53:38078         104.21.71.166:12345       TIME_WAIT  

...
```

ä¸€åˆ‡è¿è¡Œæ­£å¸¸ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å»çœ‹ WireShark çš„æŠ“åŒ…ç»“æœäº†ã€‚

* * *

WireShark æŠ“åŒ…ç»“æœåˆ†æ
----------------

é¦–å…ˆä½¿ç”¨ `tcp.options.tfo` è¿‡æ»¤æ¡ä»¶ï¼Œå¿«é€Ÿç­›é€‰å‡ºå’Œ `TCP Fast Open` æœ‰å…³çš„ TCP æŠ¥æ–‡ã€‚

![Image 5](https://dbwu.tech/images/network/tcp-fast-open/1.png)

ä¸‹é¢å¯¹ WireShark æŠ“åŒ…ç»“æœå±•å¼€åˆ†æä¸€ä¸‹ã€‚

### ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥

å½“å‘é€æ–¹ç¬¬ä¸€æ¬¡å’Œæ¥æ”¶æ–¹å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œå‘é€ 1 ä¸ª `SYN` æŠ¥æ–‡ï¼Œä»¥åŠè®¾ç½® TCP Options å­—æ®µ `TCP Fast Open` ã€‚

**æ­¤æ—¶å¹¶æ²¡æœ‰å‘é€ä»»ä½•æ•°æ®**ï¼Œæ‰€ä»¥ WireShark æŠ“åŒ…ç»“æœä¸­çš„ `Len = 0`ã€‚

![Image 6](https://dbwu.tech/images/network/tcp-fast-open/3.png)

![Image 7](https://dbwu.tech/images/network/tcp-fast-open/2.png)

æ¥æ”¶æ–¹è¿”å› `SYN-ACK` æŠ¥æ–‡çš„åŒæ—¶ï¼Œé™„å¸¦ä¸€ä¸ªéšæœºç”Ÿæˆçš„åä¸º `TFO Cookie` çš„æ ‡è¯†ç¬¦ç»™å‘é€æ–¹ã€‚

![Image 8](https://dbwu.tech/images/network/tcp-fast-open/5.png)

![Image 9](https://dbwu.tech/images/network/tcp-fast-open/4.png)

å‘é€æ–¹æ”¶åˆ° `SYN-ACK` æŠ¥æ–‡åï¼Œä¿å­˜ `TFO Cookie`ï¼Œå‘é€ `ACK` æŠ¥æ–‡ç»™æ¥æ”¶æ–¹ï¼Œå®Œæˆä¸‰æ¬¡æ¡æ‰‹ã€‚

å…¶ä¸­ `TFO Cookie` çš„å€¼ä¸º: `d82d9074a6105a13`ã€‚

ä¸‰æ¬¡æ¡æ‰‹å®Œæˆåï¼Œå¼€å§‹ä¼ è¾“æ•°æ®ã€‚

### åç»­å»ºç«‹è¿æ¥

![Image 10](https://dbwu.tech/images/network/tcp-fast-open/6.png)

é€šè¿‡æˆªå›¾å¯ä»¥çœ‹åˆ°ï¼Œåç»­å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹ TCP è¿æ¥æ—¶ï¼Œä¼šåœ¨ç¬¬ä¸€æ¬¡æ¡æ‰‹æ—¶æºå¸¦ `FTO Cookie` å¹¶ä¸”ç›´æ¥å‘é€æ•°æ®ï¼Œæ‰€ä»¥ WireShark æŠ“åŒ…ç»“æœä¸­çš„ `Len = 13`ã€‚

é‚£ä¹ˆè¿™ä¸ª 13 æ˜¯ä»€ä¹ˆï¼Ÿå°±æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ï¼Œæ­£å¥½æ˜¯ 13 ä¸ªå­—èŠ‚ã€‚

```

conn.sendto(b"Hello, Server", ...)
```

åç»­ TCP è¿æ¥å»ºç«‹ (ç¬¬ä¸€æ¬¡æ¡æ‰‹) æ—¶å°±å¯ä»¥ç›´æ¥å‘é€æ•°æ® (ç¯‡å¹…æ‰€é™ï¼Œè¿™é‡Œåªæˆªå›¾ 2 ä¸ªæ•°æ®æŠ“åŒ…è¯¦æƒ…):

![Image 11](https://dbwu.tech/images/network/tcp-fast-open/7.png)

![Image 12](https://dbwu.tech/images/network/tcp-fast-open/8.png)

æ¯ä¸ªæ•°æ®åŒ…ä¸­çš„ `TFO Cookie` çš„å€¼éƒ½æ˜¯ `d82d9074a6105a13`ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡å»ºç«‹ TCP è¿æ¥æ—¶ï¼ŒæœåŠ¡ç«¯å‘é€ `SYN-ACK` æŠ¥æ–‡æ—¶æºå¸¦çš„å€¼ã€‚

* * *

Reference
---------

*   [TCP Fast Open](https://datatracker.ietf.org/doc/html/rfc7413)
