# Interfaces and traits in C
- URL: https://antonz.org/interfaces-in-c/
- Added At: 2026-01-23 13:25:31
- Tags: #read #c #deepdive

## TL;DR
本文探讨了在C语言中实现类似Go和Rust接口多态的方法，比较了多种实现方式，推荐使用方法表（vtable）作为高效安全的实用方案，尽管不如原生语言优雅。

## Summary
文章探讨了在C语言中实现类似Go接口和Rust trait的多态行为的方法。Go的接口是结构化的（类似鸭子类型），类型无需显式声明实现接口，只要拥有匹配的方法即可；Rust的trait则需要显式实现。文章通过一个简单的Reader接口示例（读取数据到字节切片）来演示C中的实现。

在C中实现接口面临挑战，因为C缺乏原生支持。文章比较了多种方法：

- **初始方法**：在结构体中直接包含函数指针，例如定义Reader结构体包含Read函数指针。但这种方法有严重缺陷：内存开销大（每个实例存储函数指针）、布局依赖（类型转换不安全，可能导致崩溃）和类型安全性差（使用void*可能引发错误）。
- **改进方法**：将接口数据与实现分离，定义Reader结构体包含函数指针和指向实际对象的self指针。这改善了类型安全，但每个接口实例仍存储函数指针，可能浪费内存。
- **优化方法（推荐）**：使用方法表（vtable） approach。将方法提取到单独的方法表结构中，接口结构体包含指向方法表的指针和self指针。这减少了内存开销（仅两个指针），支持多个接口，且类型更安全。例如，Reader结构体包含mtab指针和self指针，Zeros实现只需定义数据字段，并通过Zeros_Reader方法返回接口实例。
- **替代方法**：将方法表放在实现者结构体中，但依赖布局转换，易出错，不如方法表方法可靠。
- **额外功能**：讨论了类型断言（如Go中的接口检查），但建议在C中避免动态类型检查，除非必要，可添加可选方法实现。

最终，文章推荐方法表方法作为最佳实践，因为它高效、安全且灵活，并提供了完整的C代码示例。结论是：在C中实现接口是可行的，但不如Go或Rust优雅，方法表方法是一个实用的起点。
