# Selectively Disabling HTTP/1.0 and HTTP/1.1 - Mark McBride
- URL: https://markmcb.com/web/selectively_disabling_http_1/
- Added At: 2026-01-31 14:53:16
- Tags: #read #network

## TL;DR
文章总结Mark McBride选择性禁用HTTP/1.X的经验。启用HTTP/3后，恶意流量多通过HTTP/1.X传输。作者实验两种方法：排除法（排除坏用户代理）比包含法更灵活，能有效减少恶意请求，建议结合日志监控和速率限制以平衡安全与可用性。

## Summary
本文总结了Mark McBride关于选择性禁用HTTP/1.0和HTTP/1.1的文章。文章基于作者在启用HTTP/3后的实际经验，旨在减少恶意流量。

**背景**
- 作者在2026年启用HTTP/3后，发现大部分流量仍通过HTTP/1.X协议传输，且其中许多是恶意请求（如攻击、恶意机器人、爬虫等）。

**方法和配置**
- 作者实验了两种选择性禁用HTTP/1.X的方法，使用nginx配置：
  - **方法1（包含法）**：仅允许已知好的用户代理（如特定文本浏览器和搜索引擎机器人）使用HTTP/1.X。配置通过map指令定义变量，检查协议和UA，对不符合条件的请求返回HTTP 426状态码（要求升级协议）。
  - **方法2（排除法）**：仅排除假定坏的用户代理（如空UA或特定模式如“Mozilla”开头的UA）使用HTTP/1.X。同样使用map和if语句返回426。
- 配置还包括将426请求记录到单独日志文件，便于监控。

**实施结果**
- 方法1初期有效减少了恶意流量，但过于严格，阻塞了部分合法流量（如Mastodon等社交媒体在生成链接预览时的HTTP/1.1请求）。作者需手动添加例外，维护成本高。
- 方法2更灵活，通过排除明显坏代理，减少了误杀。作者最终采用方法2，并结合IP速率限制和444响应（nginx特有，用于静默丢弃请求）处理已知恶意URI。
- 数据显示，阻塞HTTP/1.X后，错误请求比例大幅下降（从50%降至很低）。

**建议和结论**
- HTTP/1.0已过时，可安全禁用；HTTP/1.1仍在使用，但易受攻击。阻塞HTTP/1.X能显著减少恶意流量，但可能影响部分合法用户（如命令行浏览器或旧版机器人）。
- 作者推荐采用排除法（方法2），平衡安全与可用性。同时建议：
  - 使用日志分析工具（如lnav）监控流量。
  - 结合速率限制和444响应优化安全策略。
- 最终决策需根据具体需求：如果愿接受少量合法流量被阻塞，可选包含法；否则，排除法更稳妥。

**额外说明**
- 文章强调，此方法仅是过滤恶意流量的一个方面，应结合其他安全措施。日志分析是关键第一步，以了解流量模式。
